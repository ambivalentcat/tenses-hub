<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£—á–µ–±–Ω—ã–π –•–∞–± –ö–∏—Ä–∏–ª–ª–∞ 2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --topic-primary: #4f46e5;
            --topic-bg-soft: #eef2ff;
            --topic-border: #c7d2fe;
            --topic-text: #312e81;
        }
        body { font-family: 'Nunito', sans-serif; background-color: #F3F4F6; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-hover:hover { transform: translateY(-3px); transition: all 0.3s ease; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .tab-active { border-left: 4px solid #764ba2; background-color: #ede9fe; color: #5b21b6; font-weight: 700; }
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Custom Scrollbar */
        .timeline-scroll::-webkit-scrollbar { height: 8px; }
        .timeline-scroll::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .timeline-scroll::-webkit-scrollbar-thumb { background: #c4b5fd; border-radius: 4px; }
        .timeline-scroll::-webkit-scrollbar-thumb:hover { background: #a78bfa; }

        /* Sticky Sidebar for Desktop */
        @media (min-width: 768px) {
            .sticky-sidebar { position: sticky; top: 0; height: fit-content; }
        }

        /* Interactive Day Card */
        .day-card { transition: all 0.3s ease; cursor: pointer; user-select: none; }
        .day-card.completed { background-color: #dcfce7; border-color: #22c55e; }
        .day-card.completed h4 { color: #15803d; text-decoration: line-through; }
        .day-card.completed .check-icon { background-color: #22c55e; border-color: #22c55e; color: white; }
        .trainer-overlay { position: absolute; inset: 0; background: rgba(255,255,255,0.75); backdrop-filter: blur(1px); z-index: 5; display: flex; align-items: center; justify-content: center; text-align: center; padding: 16px; border-radius: 16px; }
        .challenge-shake { animation: challengeShake 0.35s linear; }
        .floating-timer-hud {
            position: fixed;
            top: 18px;
            right: 18px;
            z-index: 40;
            width: min(320px, 92vw);
            box-shadow: 0 14px 36px rgba(15, 23, 42, 0.16);
            pointer-events: auto;
        }
        @media (max-width: 767px) {
            .floating-timer-hud {
                top: auto;
                right: auto;
                left: 50%;
                bottom: 10px;
                transform: translateX(-50%);
                width: min(92vw, 520px);
            }
        }
        @keyframes challengeShake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-6px); }
            50% { transform: translateX(6px); }
            75% { transform: translateX(-4px); }
            100% { transform: translateX(0); }
        }
        .sticky-topic-bar {
            position: sticky;
            top: 10px;
            z-index: 35;
            background: var(--topic-bg-soft);
            border: 1px solid var(--topic-border);
            box-shadow: 0 8px 26px rgba(15, 23, 42, 0.08);
            backdrop-filter: blur(8px);
            transition: transform 0.25s ease, box-shadow 0.25s ease;
        }
        .sticky-topic-bar.sticky-topic-bar-scrolled {
            box-shadow: 0 14px 34px rgba(15, 23, 42, 0.14);
        }
        .premium-enter {
            animation: premiumEnter 0.34s cubic-bezier(.22,.61,.36,1) both;
        }
        @keyframes premiumEnter {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .task-success-pulse {
            animation: successPulse 0.62s ease-out;
        }
        @keyframes successPulse {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.42); }
            100% { box-shadow: 0 0 0 14px rgba(34, 197, 94, 0); }
        }
        .challenge-wrong-glow {
            box-shadow: 0 0 0 1px rgba(239, 68, 68, 0.45), 0 0 0 8px rgba(254, 202, 202, 0.7);
        }
        .focus-ring:focus-visible {
            outline: 2px solid var(--topic-primary);
            outline-offset: 2px;
        }
        .toast-stack {
            position: fixed;
            top: 18px;
            left: 50%;
            transform: translateX(-50%);
            width: min(94vw, 520px);
            z-index: 60;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .toast-item {
            pointer-events: auto;
            border: 1px solid var(--topic-border);
            background: var(--topic-bg-soft);
            color: var(--topic-text);
            border-radius: 12px;
            padding: 10px 12px;
            box-shadow: 0 10px 24px rgba(2, 6, 23, 0.12);
            animation: premiumEnter 0.24s ease both;
        }
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation: none !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }
    </style>
</head>
<body class="text-gray-700">

    <!-- Header -->
    <header class="gradient-bg text-white pb-24 pt-8 px-6 shadow-lg relative overflow-hidden">
        <!-- Decorative background elements -->
        <div class="absolute top-0 right-0 -mr-20 -mt-20 w-64 h-64 rounded-full bg-white opacity-10 blur-3xl"></div>
        <div class="absolute bottom-0 left-0 -ml-20 -mb-20 w-40 h-40 rounded-full bg-purple-300 opacity-10 blur-2xl"></div>

        <div class="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center relative z-10">
            <div class="mb-6 md:mb-0">
                <div class="flex items-center gap-3 mb-2">
                    <span class="bg-yellow-400 text-yellow-900 text-xs font-bold px-2 py-1 rounded uppercase tracking-wide">Student Dashboard</span>
                </div>
                <h1 class="text-3xl md:text-5xl font-extrabold mb-2 tracking-tight">–ü—Ä–∏–≤–µ—Ç, –ö–∏—Ä–∏–ª–ª! üëã</h1>
                <p class="text-blue-100 text-lg font-medium">–î–∞–≤–∞–π –ø–æ–∫–æ—Ä–∏–º –∞–Ω–≥–ª–∏–π—Å–∫—É—é –≥—Ä–∞–º–º–∞—Ç–∏–∫—É!</p>
            </div>
            
            <!-- Gamification Stats -->
            <div class="bg-white/10 backdrop-blur-md border border-white/20 rounded-2xl p-4 flex items-center gap-6 shadow-xl">
                <div class="text-center">
                    <p class="text-xs text-blue-200 uppercase font-bold tracking-wider">–¢–≤–æ–π —É—Ä–æ–≤–µ–Ω—å</p>
                    <div class="text-3xl font-black text-yellow-300" id="xpDisplay">0 XP</div>
                </div>
                <div class="h-10 w-px bg-white/20"></div>
                <div class="text-center">
                    <p class="text-xs text-blue-200 uppercase font-bold tracking-wider">–ü—Ä–æ–≥—Ä–µ—Å—Å</p>
                    <div class="text-xl font-bold text-white" id="totalProgressDisplay">0%</div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-6xl mx-auto px-4 -mt-16 pb-20 relative z-20">
        <div id="stickyTopicBar" class="sticky-topic-bar premium-enter rounded-2xl px-3 py-2 mb-4">
            <div class="flex flex-wrap items-center gap-2 sm:gap-3">
                <div class="min-w-0 flex-1">
                    <p id="stickyActiveTopicTitle" class="font-bold text-sm truncate text-gray-900">Topic</p>
                    <p id="stickyActiveTopicProgress" class="text-[11px] text-gray-600">0/0 completed</p>
                </div>
                <span id="stickyTimerPill" class="hidden text-xs font-extrabold rounded-full px-3 py-1 border border-white/60 bg-white/70 text-gray-800">
                    ‚è± <span id="stickyChallengeTimeLeft">00:00</span>
                </span>
                <button id="stickySoundBtn" onclick="toggleChallengeSound()" class="focus-ring text-xs px-3 py-1.5 rounded-lg border bg-white/80 hover:bg-white transition-colors">
                    üîä Sound
                </button>
                <button id="stickyResetBtn" onclick="resetChallengeTopic()" class="focus-ring text-xs px-3 py-1.5 rounded-lg border bg-white/80 hover:bg-white transition-colors">
                    Reset
                </button>
            </div>
        </div>
        
        <!-- Top Stats Row -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">
            <!-- Streak + Goal -->
            <div class="bg-white rounded-2xl shadow-sm p-6 card-hover border-l-4 border-blue-500">
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <h3 class="font-bold text-lg text-gray-800 flex items-center gap-2">
                            <i class="fas fa-fire text-orange-500"></i> Streak + Goal
                        </h3>
                        <p class="text-xs text-gray-400">Practice consistency and daily target</p>
                    </div>
                    <span id="streakBadge" class="bg-blue-50 text-blue-600 px-3 py-1 rounded-full font-bold text-sm">0 days</span>
                </div>
                <div class="mb-4">
                    <p class="text-xs uppercase tracking-wider text-gray-400 font-bold">Today</p>
                    <p class="text-sm font-bold text-gray-700">Today: <span id="todayGoalText">0/12</span></p>
                </div>
                <div class="w-full bg-gray-100 rounded-full h-2 mb-4">
                    <div id="todayGoalBar" class="bg-blue-500 h-2 rounded-full transition-all" style="width: 0%"></div>
                </div>
                <p class="text-xs font-semibold text-gray-500">
                    <i class="fas fa-stopwatch mr-1 text-indigo-500"></i><span id="challengePbText">Best time (PB): ‚Äî</span>
                </p>
            </div>

            <!-- Mistake Bank -->
            <div class="bg-white rounded-2xl shadow-sm p-6 card-hover border-l-4 border-purple-500">
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <h3 class="font-bold text-lg text-gray-800 flex items-center gap-2">
                            <i class="fas fa-bug text-rose-500"></i> Mistake Bank
                        </h3>
                        <p class="text-xs text-gray-400">Weak spots to review</p>
                    </div>
                    <span id="wrongTodayBadge" class="bg-rose-50 text-rose-600 px-3 py-1 rounded-full font-bold text-sm">0 today</span>
                </div>
                <div id="mistakeTopList" class="space-y-2 mb-4 text-xs text-gray-600">
                    <p class="text-gray-400">No mistakes yet.</p>
                </div>
                <button onclick="reviewMistakes()" class="focus-ring text-xs px-3 py-2 rounded-lg border border-purple-200 text-purple-700 hover:bg-purple-50 transition-colors">
                    Review mistakes
                </button>
            </div>
        </div>
        <div id="mistakeBankSection" class="bg-white rounded-2xl shadow-sm p-4 mb-10 border border-gray-100">
            <div class="flex items-center justify-between gap-3 mb-3">
                <h3 class="text-sm font-extrabold text-gray-800">Top 3 Most Missed</h3>
                <span class="text-[11px] text-gray-400">Global ranking</span>
            </div>
            <div id="mistakeBankSectionList" class="space-y-2 text-sm text-gray-700">
                <p class="text-gray-400 text-xs">No problematic tasks yet.</p>
            </div>
        </div>
        <div class="bg-white rounded-2xl shadow-sm p-4 mb-10 border border-gray-100">
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-sm">
                <div class="bg-gray-50 rounded-xl p-3">
                    <p class="text-xs uppercase tracking-wider text-gray-400 font-bold">–í—ã–ø–æ–ª–Ω–µ–Ω–æ –∑–∞–¥–∞—á</p>
                    <p class="text-xl font-extrabold text-gray-800"><span id="completedTasksDisplay">0</span>/<span id="totalTasksDisplay">0</span></p>
                </div>
                <div class="bg-gray-50 rounded-xl p-3">
                    <p class="text-xs uppercase tracking-wider text-gray-400 font-bold">–ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã</p>
                    <p class="text-xl font-extrabold text-green-600" id="correctCountDisplay">0</p>
                </div>
                <div class="bg-gray-50 rounded-xl p-3">
                    <p class="text-xs uppercase tracking-wider text-gray-400 font-bold">–ü–æ–ø—ã—Ç–∫–∏</p>
                    <p class="text-xl font-extrabold text-indigo-600" id="attemptCountDisplay">0</p>
                </div>
            </div>
        </div>

        <!-- Interactive Learning Area -->
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden min-h-[600px] flex flex-col md:flex-row">
            
            <!-- Sidebar -->
            <div class="w-full md:w-1/4 bg-gray-50 border-r border-gray-100 sticky-sidebar z-10">
                <div class="p-5 border-b border-gray-100 bg-gray-50">
                    <h2 class="font-bold text-gray-700 uppercase text-xs tracking-wider flex items-center gap-2">
                        <i class="fas fa-graduation-cap text-purple-500"></i>
                        –ó–æ–Ω—ã —Ä–æ—Å—Ç–∞ (–¢–µ–º—ã)
                    </h2>
                </div>
                <nav class="flex flex-col" id="topicTabs">
                    <!-- JS Injected -->
                </nav>
            </div>

            <!-- Content -->
            <div class="w-full md:w-3/4 p-6 md:p-10 relative bg-white">
                <div id="contentDisplay" class="fade-in">
                    <!-- JS Injected -->
                </div>
            </div>
        </div>

        <!-- Topic Stats -->
        <div id="topicStatsSection" class="mt-12">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                    <i class="fas fa-chart-pie text-indigo-600"></i> Stats
                </h2>
                <div class="text-sm bg-white px-3 py-1 rounded-lg shadow-sm text-gray-500">
                    –ü–æ –∫–∞–∂–¥–æ–π —Ç–µ–º–µ
                </div>
            </div>
            <div id="topicStatsContainer" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- JS Injected -->
            </div>
        </div>

        <!-- 7 Day Plan -->
        <div class="mt-12">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                    <i class="fas fa-calendar-check text-purple-600"></i> –ü–ª–∞–Ω –Ω–∞ 7 –¥–Ω–µ–π
                </h2>
                <div class="text-sm bg-white px-3 py-1 rounded-lg shadow-sm text-gray-500">
                    <span id="daysCompleted">0</span>/7 –≤—ã–ø–æ–ª–Ω–µ–Ω–æ
                </div>
            </div>
            
            <p class="text-sm text-gray-500 mb-4 bg-blue-50 p-3 rounded-lg border border-blue-100 inline-block">
                <i class="fas fa-info-circle text-blue-500 mr-2"></i>–ù–∞–∂–∏–º–∞–π –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ –¥–Ω–µ–π, —á—Ç–æ–±—ã –æ—Ç–º–µ—á–∞—Ç—å –∏—Ö –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–º–∏!
            </p>

            <div class="bg-white rounded-2xl shadow-md p-6 overflow-x-auto timeline-scroll">
                <div class="flex gap-4 min-w-max pb-4" id="planTimeline">
                    <!-- JS Injected -->
                </div>
        </div>
            
            <!-- Reset Button -->
            <div class="mt-6 text-center flex items-center justify-center gap-4">
                <button onclick="exportResults()" class="text-xs text-indigo-500 hover:text-indigo-700 underline">–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</button>
                <button onclick="exportPdfReport()" class="text-xs text-gray-500 hover:text-gray-700 underline">Export PDF</button>
                <button onclick="exportWordReport()" class="text-xs text-emerald-500 hover:text-emerald-700 underline">Export Word</button>
                <button onclick="resetProgress()" class="text-xs text-red-400 hover:text-red-600 underline">–°–±—Ä–æ—Å–∏—Ç—å –≤–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å—Å</button>
            </div>
        </div>

    </main>

    <div id="toastContainer" class="toast-stack" aria-live="polite" aria-atomic="true"></div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-10 text-center mt-10 border-t border-gray-700">
        <p class="font-bold text-lg mb-2">Never Give Up! üöÄ</p>
        <p class="opacity-60 text-sm">–°–æ–∑–¥–∞–Ω–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è –ö–∏—Ä–∏–ª–ª–∞</p>
    </footer>

    <!-- Logic -->
    <script>
        /* --- 1. DATA --- */
        const APP_VERSION = "2.2";
        const STORAGE_KEY_V2 = "kirill_progress_v2";
        const LEGACY_QUIZ_KEY = "kirill_quiz_state";
        const LEGACY_DAY_KEY = "kirill_day_state";
        const OLD_STORAGE_KEY_V2 = "diana_progress_v2";
        const OLD_LEGACY_QUIZ_KEY = "diana_quiz_state";
        const OLD_LEGACY_DAY_KEY = "diana_day_state";
        const CHALLENGE_TOTAL_SECONDS = 360;

        const topics = [
            {
                id: 'time_markers',
                title: "Time Markers (–ú–∞—Ä–∫–µ—Ä—ã –≤—Ä–µ–º–µ–Ω–∏)",
                icon: "fa-tags",
                summary: "–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ –º–∞—Ä–∫–µ—Ä–∞–º –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É, –≤–∫–ª—é—á–∞—è –Ω–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω—ã–µ —Å–ª—É—á–∞–∏.",
                theory: `
                    <div class="bg-sky-50 p-5 rounded-xl mb-6 text-sky-900 border-l-4 border-sky-500 shadow-sm">
                        <h4 class="font-bold mb-2">–ö—Ä–∞—Ç–∫–æ</h4>
                        <p class="text-sm mb-2">–ú–∞—Ä–∫–µ—Ä—ã –≤—Ä–µ–º–µ–Ω–∏ –ø–æ–º–æ–≥–∞—é—Ç –≤—ã–±—Ä–∞—Ç—å –≤—Ä–µ–º—è, –Ω–æ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —Å–ª–æ–≤–∞ —Ä–∞–±–æ—Ç–∞—é—Ç —Ç–æ–ª—å–∫–æ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ.</p>
                        <div class="bg-white border border-sky-200 rounded-lg p-3 text-sm mb-2">
                            <strong>–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:</strong> —Å–Ω–∞—á–∞–ª–∞ —Å–º–æ—Ç—Ä–∏ –Ω–∞ –º–∞—Ä–∫–µ—Ä, –∑–∞—Ç–µ–º –ø—Ä–æ–≤–µ—Ä—è–π –∫–æ–Ω—Ç–µ–∫—Å—Ç (finished vs so far, background vs interrupting action).
                        </div>
                        <p class="text-sm mb-2"><strong>Time markers:</strong></p>
                        <div class="flex flex-wrap gap-2">
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-sky-100 text-sky-800 border border-sky-200">every day ‚Äî –∫–∞–∂–¥—ã–π –¥–µ–Ω—å</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-sky-100 text-sky-800 border border-sky-200">right now ‚Äî –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-sky-100 text-sky-800 border border-sky-200">yesterday ‚Äî –≤—á–µ—Ä–∞</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-sky-100 text-sky-800 border border-sky-200">at 5 pm yesterday ‚Äî –≤—á–µ—Ä–∞ –≤ 5 –≤–µ—á–µ—Ä–∞</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-sky-100 text-sky-800 border border-sky-200">tomorrow ‚Äî –∑–∞–≤—Ç—Ä–∞</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-sky-100 text-sky-800 border border-sky-200">already ‚Äî —É–∂–µ</span>
                        </div>
                    </div>
                `,
                tasks: [
                    {
                        id: "tm_match_tr_1",
                        type: "match",
                        prompt: "–°–æ–ø–æ—Å—Ç–∞–≤—å English marker —Å —Ä—É—Å—Å–∫–∏–º –ø–µ—Ä–µ–≤–æ–¥–æ–º (–º–∏–∫—Å –≤—Ä–µ–º–µ–Ω).",
                        leftLabel: "English marker",
                        rightLabel: "–†—É—Å—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥",
                        leftItems: [
                            { key: "tr1_every_day", text: "every day" },
                            { key: "tr1_right_now", text: "right now" },
                            { key: "tr1_yesterday", text: "yesterday" },
                            { key: "tr1_tomorrow", text: "tomorrow" },
                            { key: "tr1_already", text: "already" },
                            { key: "tr1_while", text: "while" }
                        ],
                        rightItems: [
                            { key: "tr1_already_ru", text: "—É–∂–µ" },
                            { key: "tr1_while_ru", text: "–≤ —Ç–æ –≤—Ä–µ–º—è –∫–∞–∫" },
                            { key: "tr1_every_day_ru", text: "–∫–∞–∂–¥—ã–π –¥–µ–Ω—å" },
                            { key: "tr1_right_now_ru", text: "–ø—Ä—è–º–æ —Å–µ–π—á–∞—Å" },
                            { key: "tr1_tomorrow_ru", text: "–∑–∞–≤—Ç—Ä–∞" },
                            { key: "tr1_yesterday_ru", text: "–≤—á–µ—Ä–∞" }
                        ],
                        correct: {
                            tr1_every_day: "tr1_every_day_ru",
                            tr1_right_now: "tr1_right_now_ru",
                            tr1_yesterday: "tr1_yesterday_ru",
                            tr1_tomorrow: "tr1_tomorrow_ru",
                            tr1_already: "tr1_already_ru",
                            tr1_while: "tr1_while_ru"
                        },
                        explanation: "–ú–∞—Ä–∫–µ—Ä–Ω—ã–µ —Å–ª–æ–≤–∞ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –≤—Ä–µ–º–µ–Ω –≤ –æ–¥–Ω–æ–º –∑–∞–¥–∞–Ω–∏–∏."
                    },
                    {
                        id: "tm_match_tr_2",
                        type: "match",
                        prompt: "–°–æ–ø–æ—Å—Ç–∞–≤—å English marker —Å —Ä—É—Å—Å–∫–∏–º –ø–µ—Ä–µ–≤–æ–¥–æ–º (–º–∏–∫—Å –≤—Ä–µ–º–µ–Ω).",
                        leftLabel: "English marker",
                        rightLabel: "–†—É—Å—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥",
                        leftItems: [
                            { key: "tr2_on_fridays", text: "on Fridays" },
                            { key: "tr2_at_the_moment", text: "at the moment" },
                            { key: "tr2_last_month", text: "last month" },
                            { key: "tr2_at_that_moment", text: "at that moment" },
                            { key: "tr2_soon", text: "soon" },
                            { key: "tr2_yet", text: "yet" }
                        ],
                        rightItems: [
                            { key: "tr2_at_that_moment_ru", text: "–≤ —Ç–æ—Ç –º–æ–º–µ–Ω—Ç" },
                            { key: "tr2_yet_ru", text: "–µ—â–µ (–≤–æ–ø—Ä–æ—Å/–æ—Ç—Ä–∏—Ü.)" },
                            { key: "tr2_at_the_moment_ru", text: "–≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç" },
                            { key: "tr2_last_month_ru", text: "–≤ –ø—Ä–æ—à–ª–æ–º –º–µ—Å—è—Ü–µ" },
                            { key: "tr2_soon_ru", text: "—Å–∫–æ—Ä–æ" },
                            { key: "tr2_on_fridays_ru", text: "–ø–æ –ø—è—Ç–Ω–∏—Ü–∞–º" }
                        ],
                        correct: {
                            tr2_on_fridays: "tr2_on_fridays_ru",
                            tr2_at_the_moment: "tr2_at_the_moment_ru",
                            tr2_last_month: "tr2_last_month_ru",
                            tr2_at_that_moment: "tr2_at_that_moment_ru",
                            tr2_soon: "tr2_soon_ru",
                            tr2_yet: "tr2_yet_ru"
                        },
                        explanation: "–ü–µ—Ä–µ–≤–æ–¥—ã —É–Ω–∏–∫–∞–ª—å–Ω—ã, –º–∞—Ä–∫–µ—Ä—ã –ø–µ—Ä–µ–º–µ—à–∞–Ω—ã –ø–æ –≤—Ä–µ–º–µ–Ω–∞–º."
                    },
                    {
                        id: "tm_match_tr_3",
                        type: "match",
                        prompt: "–°–æ–ø–æ—Å—Ç–∞–≤—å English marker —Å —Ä—É—Å—Å–∫–∏–º –ø–µ—Ä–µ–≤–æ–¥–æ–º (–º–∏–∫—Å –≤—Ä–µ–º–µ–Ω).",
                        leftLabel: "English marker",
                        rightLabel: "–†—É—Å—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥",
                        leftItems: [
                            { key: "tr3_usually", text: "usually" },
                            { key: "tr3_currently", text: "currently" },
                            { key: "tr3_two_hours_ago", text: "two hours ago" },
                            { key: "tr3_from_3_to_5", text: "from 3 to 5" },
                            { key: "tr3_i_think", text: "I think" },
                            { key: "tr3_ever", text: "ever" }
                        ],
                        rightItems: [
                            { key: "tr3_two_hours_ago_ru", text: "–¥–≤–∞ —á–∞—Å–∞ –Ω–∞–∑–∞–¥" },
                            { key: "tr3_ever_ru", text: "–∫–æ–≥–¥–∞-–ª–∏–±–æ" },
                            { key: "tr3_usually_ru", text: "–æ–±—ã—á–Ω–æ" },
                            { key: "tr3_i_think_ru", text: "—è –¥—É–º–∞—é" },
                            { key: "tr3_currently_ru", text: "–≤ –Ω–∞—Å—Ç–æ—è—â–µ–µ –≤—Ä–µ–º—è" },
                            { key: "tr3_from_3_to_5_ru", text: "—Å 3 –¥–æ 5" }
                        ],
                        correct: {
                            tr3_usually: "tr3_usually_ru",
                            tr3_currently: "tr3_currently_ru",
                            tr3_two_hours_ago: "tr3_two_hours_ago_ru",
                            tr3_from_3_to_5: "tr3_from_3_to_5_ru",
                            tr3_i_think: "tr3_i_think_ru",
                            tr3_ever: "tr3_ever_ru"
                        },
                        explanation: "–í –∫–∞–∂–¥–æ–º –Ω–∞–±–æ—Ä–µ –µ—Å—Ç—å –º–∞—Ä–∫–µ—Ä—ã –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –≤—Ä–µ–º–µ–Ω."
                    },
                    {
                        id: "tm_match_tr_4",
                        type: "match",
                        prompt: "–°–æ–ø–æ—Å—Ç–∞–≤—å English marker —Å —Ä—É—Å—Å–∫–∏–º –ø–µ—Ä–µ–≤–æ–¥–æ–º (–º–∏–∫—Å –≤—Ä–µ–º–µ–Ω).",
                        leftLabel: "English marker",
                        rightLabel: "–†—É—Å—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥",
                        leftItems: [
                            { key: "tr4_every_weekend", text: "every weekend" },
                            { key: "tr4_now", text: "now" },
                            { key: "tr4_in_2020", text: "in 2020" },
                            { key: "tr4_all_night", text: "all night" },
                            { key: "tr4_next_week", text: "next week" },
                            { key: "tr4_just", text: "just" }
                        ],
                        rightItems: [
                            { key: "tr4_now_ru", text: "—Å–µ–π—á–∞—Å" },
                            { key: "tr4_next_week_ru", text: "–Ω–∞ —Å–ª–µ–¥—É—é—â–µ–π –Ω–µ–¥–µ–ª–µ" },
                            { key: "tr4_in_2020_ru", text: "–≤ 2020 –≥–æ–¥—É" },
                            { key: "tr4_all_night_ru", text: "–≤—Å—é –Ω–æ—á—å" },
                            { key: "tr4_every_weekend_ru", text: "–∫–∞–∂–¥—ã–µ –≤—ã—Ö–æ–¥–Ω—ã–µ" },
                            { key: "tr4_just_ru", text: "—Ç–æ–ª—å–∫–æ —á—Ç–æ" }
                        ],
                        correct: {
                            tr4_every_weekend: "tr4_every_weekend_ru",
                            tr4_now: "tr4_now_ru",
                            tr4_in_2020: "tr4_in_2020_ru",
                            tr4_all_night: "tr4_all_night_ru",
                            tr4_next_week: "tr4_next_week_ru",
                            tr4_just: "tr4_just_ru"
                        },
                        explanation: "–ó–∞–¥–∞–Ω–∏–µ –Ω–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤ –±–µ–∑ –æ–ø–æ—Ä—ã –Ω–∞ –æ–¥–∏–Ω —à–∞–±–ª–æ–Ω."
                    },
                    {
                        id: "tm_match_tense_1",
                        type: "match",
                        prompt: "–°–æ–ø–æ—Å—Ç–∞–≤—å –º–∞—Ä–∫–µ—Ä –∏ –≤—Ä–µ–º—è (–∫–∞–∂–¥–∞—è –ø–∞—Ä–∞ = —Ä–∞–∑–Ω–æ–µ –≤—Ä–µ–º—è).",
                        leftLabel: "Marker",
                        rightLabel: "Tense",
                        leftItems: [
                            { key: "t1_every_day", text: "every day" },
                            { key: "t1_right_now", text: "right now" },
                            { key: "t1_yesterday", text: "yesterday" },
                            { key: "t1_at_5_pm_yesterday", text: "at 5 pm yesterday" },
                            { key: "t1_tomorrow", text: "tomorrow" },
                            { key: "t1_already", text: "already" }
                        ],
                        rightItems: [
                            { key: "t1_ps", text: "Present Simple" },
                            { key: "t1_pc", text: "Present Continuous" },
                            { key: "t1_past", text: "Past Simple" },
                            { key: "t1_past_cont", text: "Past Continuous" },
                            { key: "t1_future", text: "Future Simple / will" },
                            { key: "t1_pp", text: "Present Perfect" }
                        ],
                        correct: {
                            t1_every_day: "t1_ps",
                            t1_right_now: "t1_pc",
                            t1_yesterday: "t1_past",
                            t1_at_5_pm_yesterday: "t1_past_cont",
                            t1_tomorrow: "t1_future",
                            t1_already: "t1_pp"
                        },
                        explanation: "–í—Å–µ 6 –≤—Ä–µ–º–µ–Ω —Å–º–µ—à–∞–Ω—ã, —Å–ø—Ä–∞–≤–∞ –Ω–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤."
                    },
                    {
                        id: "tm_match_tense_2",
                        type: "match",
                        prompt: "–°–æ–ø–æ—Å—Ç–∞–≤—å –º–∞—Ä–∫–µ—Ä –∏ –≤—Ä–µ–º—è (–∫–∞–∂–¥–∞—è –ø–∞—Ä–∞ = —Ä–∞–∑–Ω–æ–µ –≤—Ä–µ–º—è).",
                        leftLabel: "Marker",
                        rightLabel: "Tense",
                        leftItems: [
                            { key: "t2_on_mondays", text: "on Mondays" },
                            { key: "t2_at_the_moment", text: "at the moment" },
                            { key: "t2_two_days_ago", text: "two days ago" },
                            { key: "t2_while", text: "while" },
                            { key: "t2_next_week", text: "next week" },
                            { key: "t2_just", text: "just" }
                        ],
                        rightItems: [
                            { key: "t2_ps", text: "Present Simple" },
                            { key: "t2_pc", text: "Present Continuous" },
                            { key: "t2_past", text: "Past Simple" },
                            { key: "t2_past_cont", text: "Past Continuous" },
                            { key: "t2_future", text: "Future Simple / will" },
                            { key: "t2_pp", text: "Present Perfect" }
                        ],
                        correct: {
                            t2_on_mondays: "t2_ps",
                            t2_at_the_moment: "t2_pc",
                            t2_two_days_ago: "t2_past",
                            t2_while: "t2_past_cont",
                            t2_next_week: "t2_future",
                            t2_just: "t2_pp"
                        },
                        explanation: "–ù—É–∂–Ω–æ —Ä–∞–∑–ª–∏—á–∞—Ç—å –ø–æ—Ö–æ–∂–∏–µ –ø–æ —Å–º—ã—Å–ª—É, –Ω–æ —Ä–∞–∑–Ω—ã–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –º–∞—Ä–∫–µ—Ä—ã."
                    },
                    {
                        id: "tm_match_tense_3",
                        type: "match",
                        prompt: "–°–æ–ø–æ—Å—Ç–∞–≤—å –º–∞—Ä–∫–µ—Ä –∏ –≤—Ä–µ–º—è (–∫–∞–∂–¥–∞—è –ø–∞—Ä–∞ = —Ä–∞–∑–Ω–æ–µ –≤—Ä–µ–º—è).",
                        leftLabel: "Marker",
                        rightLabel: "Tense",
                        leftItems: [
                            { key: "t3_often", text: "often" },
                            { key: "t3_now", text: "now" },
                            { key: "t3_last_year", text: "last year" },
                            { key: "t3_all_night", text: "all night" },
                            { key: "t3_soon", text: "soon" },
                            { key: "t3_ever", text: "ever" }
                        ],
                        rightItems: [
                            { key: "t3_ps", text: "Present Simple" },
                            { key: "t3_pc", text: "Present Continuous" },
                            { key: "t3_past", text: "Past Simple" },
                            { key: "t3_past_cont", text: "Past Continuous" },
                            { key: "t3_future", text: "Future Simple / will" },
                            { key: "t3_pp", text: "Present Perfect" }
                        ],
                        correct: {
                            t3_often: "t3_ps",
                            t3_now: "t3_pc",
                            t3_last_year: "t3_past",
                            t3_all_night: "t3_past_cont",
                            t3_soon: "t3_future",
                            t3_ever: "t3_pp"
                        },
                        explanation: "–ú–∞—Ä–∫–µ—Ä—ã —Ä–∞–∑–Ω—ã—Ö –≥—Ä—É–ø–ø —Å–º–µ—à–∞–Ω—ã –∫–∞–∫ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –¥–∏—Å—Ç—Ä–∞–∫—Ç–æ—Ä—ã."
                    },
                    {
                        id: "tm_match_tense_4",
                        type: "match",
                        prompt: "–°–æ–ø–æ—Å—Ç–∞–≤—å –º–∞—Ä–∫–µ—Ä –∏ –≤—Ä–µ–º—è (–∫–∞–∂–¥–∞—è –ø–∞—Ä–∞ = —Ä–∞–∑–Ω–æ–µ –≤—Ä–µ–º—è).",
                        leftLabel: "Marker",
                        rightLabel: "Tense",
                        leftItems: [
                            { key: "t4_every_weekend", text: "every weekend" },
                            { key: "t4_currently", text: "currently" },
                            { key: "t4_in_2019", text: "in 2019" },
                            { key: "t4_from_3_to_5_yesterday", text: "from 3 to 5 yesterday" },
                            { key: "t4_i_think", text: "I think" },
                            { key: "t4_yet", text: "yet" }
                        ],
                        rightItems: [
                            { key: "t4_ps", text: "Present Simple" },
                            { key: "t4_pc", text: "Present Continuous" },
                            { key: "t4_past", text: "Past Simple" },
                            { key: "t4_past_cont", text: "Past Continuous" },
                            { key: "t4_future", text: "Future Simple / will" },
                            { key: "t4_pp", text: "Present Perfect" }
                        ],
                        correct: {
                            t4_every_weekend: "t4_ps",
                            t4_currently: "t4_pc",
                            t4_in_2019: "t4_past",
                            t4_from_3_to_5_yesterday: "t4_past_cont",
                            t4_i_think: "t4_future",
                            t4_yet: "t4_pp"
                        },
                        explanation: "–ö–∞–∂–¥–æ–º—É –º–∞—Ä–∫–µ—Ä—É —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è."
                    },
                    {
                        id: "tm_match_ctx_1",
                        type: "match",
                        prompt: "–°–æ–ø–æ—Å—Ç–∞–≤—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ –≤—Ä–µ–º—è (today/these days/nowadays).",
                        leftLabel: "Context snippet",
                        rightLabel: "Tense",
                        leftItems: [
                            { key: "c1_today_so_far", text: "I have done three tasks today so far." },
                            { key: "c1_today_9am", text: "I did this task today at 9 AM." },
                            { key: "c1_these_days", text: "I'm working late these days." },
                            { key: "c1_nowadays", text: "People use smartphones nowadays." },
                            { key: "c1_at_that_moment", text: "At that moment, we were waiting for the bus." },
                            { key: "c1_tomorrow", text: "I will send the report tomorrow." }
                        ],
                        rightItems: [
                            { key: "c1_ps", text: "Present Simple" },
                            { key: "c1_pc", text: "Present Continuous" },
                            { key: "c1_past", text: "Past Simple" },
                            { key: "c1_past_cont", text: "Past Continuous" },
                            { key: "c1_future", text: "Future Simple / will" },
                            { key: "c1_pp", text: "Present Perfect" }
                        ],
                        correct: {
                            c1_today_so_far: "c1_pp",
                            c1_today_9am: "c1_past",
                            c1_these_days: "c1_pc",
                            c1_nowadays: "c1_ps",
                            c1_at_that_moment: "c1_past_cont",
                            c1_tomorrow: "c1_future"
                        },
                        explanation: "today/these days/nowadays —Ä–∞–∑–ª–∏—á–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É."
                    },
                    {
                        id: "tm_match_ctx_2",
                        type: "match",
                        prompt: "–°–æ–ø–æ—Å—Ç–∞–≤—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ –≤—Ä–µ–º—è (this week/recently).",
                        leftLabel: "Context snippet",
                        rightLabel: "Tense",
                        leftItems: [
                            { key: "c2_this_week_so_far", text: "I have studied a lot this week." },
                            { key: "c2_this_week_monday", text: "I studied a lot this week on Monday." },
                            { key: "c2_recently_experience", text: "I have seen him recently." },
                            { key: "c2_recently_finished", text: "I saw him recently at the mall." },
                            { key: "c2_while", text: "While we were walking, it started to rain." },
                            { key: "c2_prediction", text: "I think they will win." }
                        ],
                        rightItems: [
                            { key: "c2_ps", text: "Present Simple" },
                            { key: "c2_pc", text: "Present Continuous" },
                            { key: "c2_past", text: "Past Simple" },
                            { key: "c2_past_cont", text: "Past Continuous" },
                            { key: "c2_future", text: "Future Simple / will" },
                            { key: "c2_pp", text: "Present Perfect" }
                        ],
                        correct: {
                            c2_this_week_so_far: "c2_pp",
                            c2_this_week_monday: "c2_past",
                            c2_recently_experience: "c2_pp",
                            c2_recently_finished: "c2_past",
                            c2_while: "c2_past_cont",
                            c2_prediction: "c2_future"
                        },
                        explanation: "this week/recently —Ç—Ä–µ–±—É—é—Ç —Ç–æ—á–Ω–æ–≥–æ —á—Ç–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ finished vs so far."
                    },
                    {
                        id: "tm_match_ctx_3",
                        type: "match",
                        prompt: "–°–æ–ø–æ—Å—Ç–∞–≤—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ –≤—Ä–µ–º—è (mixed clues).",
                        leftLabel: "Context snippet",
                        rightLabel: "Tense",
                        leftItems: [
                            { key: "c3_habit", text: "She usually drinks tea after lunch." },
                            { key: "c3_now_process", text: "She is drinking tea right now." },
                            { key: "c3_finished_past", text: "She drank tea at 8 yesterday." },
                            { key: "c3_background", text: "She was drinking tea when I called." },
                            { key: "c3_future_plan", text: "She will drink tea tomorrow morning." },
                            { key: "c3_result", text: "She has already drunk her tea." }
                        ],
                        rightItems: [
                            { key: "c3_ps", text: "Present Simple" },
                            { key: "c3_pc", text: "Present Continuous" },
                            { key: "c3_past", text: "Past Simple" },
                            { key: "c3_past_cont", text: "Past Continuous" },
                            { key: "c3_future", text: "Future Simple / will" },
                            { key: "c3_pp", text: "Present Perfect" }
                        ],
                        correct: {
                            c3_habit: "c3_ps",
                            c3_now_process: "c3_pc",
                            c3_finished_past: "c3_past",
                            c3_background: "c3_past_cont",
                            c3_future_plan: "c3_future",
                            c3_result: "c3_pp"
                        },
                        explanation: "–û–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –≥–ª–∞–≥–æ–ª, –Ω–æ —Ä–∞–∑–Ω—ã–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–∞."
                    },
                    {
                        id: "tm_match_ctx_4",
                        type: "match",
                        prompt: "–°–æ–ø–æ—Å—Ç–∞–≤—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ –≤—Ä–µ–º—è (–æ–¥–Ω–æ–∑–Ω–∞—á–Ω—ã–π –≤—ã–±–æ—Ä –ø–æ –¥–µ—Ç–∞–ª—è–º).",
                        leftLabel: "Context snippet",
                        rightLabel: "Tense",
                        leftItems: [
                            { key: "c4_general_fact", text: "Trains leave every hour." },
                            { key: "c4_temp_now", text: "We are staying with friends this week." },
                            { key: "c4_past_event", text: "We stayed with friends last weekend." },
                            { key: "c4_in_progress_past", text: "We were staying with friends from 3 to 5 yesterday." },
                            { key: "c4_future", text: "We will stay there next month." },
                            { key: "c4_life_experience", text: "We have stayed there before." }
                        ],
                        rightItems: [
                            { key: "c4_ps", text: "Present Simple" },
                            { key: "c4_pc", text: "Present Continuous" },
                            { key: "c4_past", text: "Past Simple" },
                            { key: "c4_past_cont", text: "Past Continuous" },
                            { key: "c4_future", text: "Future Simple / will" },
                            { key: "c4_pp", text: "Present Perfect" }
                        ],
                        correct: {
                            c4_general_fact: "c4_ps",
                            c4_temp_now: "c4_pc",
                            c4_past_event: "c4_past",
                            c4_in_progress_past: "c4_past_cont",
                            c4_future: "c4_future",
                            c4_life_experience: "c4_pp"
                        },
                        explanation: "–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –¥–µ—Ç–∞–ª–∏ —É–±–∏—Ä–∞—é—Ç –¥–≤—É—Å–º—ã—Å–ª–µ–Ω–Ω–æ—Å—Ç—å."
                    }
                ]
            },
            {
                id: 'present_simple',
                title: "Present Simple",
                icon: "fa-calendar-day",
                summary: "–†–µ–≥—É–ª—è—Ä–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è, —Ñ–∞–∫—Ç—ã –∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è: usually, every day, never.",
                theory: `
                    <div class="bg-blue-50 p-5 rounded-xl mb-6 text-blue-900 border-l-4 border-blue-500 shadow-sm">
                        <h4 class="font-bold mb-2">–ö—Ä–∞—Ç–∫–æ</h4>
                        <p class="text-sm mb-2">–ò—Å–ø–æ–ª—å–∑—É–µ–º <strong>Present Simple</strong> –¥–ª—è –ø—Ä–∏–≤—ã—á–µ–∫, —Ñ–∞–∫—Ç–æ–≤ –∏ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è –¥–µ–π—Å—Ç–≤–∏–π.</p>
                        <div class="bg-white border border-blue-200 rounded-lg p-3 text-sm mb-2">
                            <strong>–§–æ—Ä–º—É–ª–∞:</strong> I/You/We/They + V1, He/She/It + V1+s/es
                        </div>
                        <p class="text-sm"><strong>–ü—Ä–∏–º–µ—Ä—ã:</strong> I go to work every day. She watches videos on Sundays.</p>
                        <p class="text-sm mt-2 mb-2"><strong>Time markers:</strong></p>
                        <div class="flex flex-wrap gap-2 mb-2">
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-blue-100 text-blue-800 border border-blue-200">always ‚Äî –≤—Å–µ–≥–¥–∞</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-blue-100 text-blue-800 border border-blue-200">usually ‚Äî –æ–±—ã—á–Ω–æ</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-blue-100 text-blue-800 border border-blue-200">every day ‚Äî –∫–∞–∂–¥—ã–π –¥–µ–Ω—å</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-blue-100 text-blue-800 border border-blue-200">often ‚Äî —á–∞—Å—Ç–æ</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-blue-100 text-blue-800 border border-blue-200">never ‚Äî –Ω–∏–∫–æ–≥–¥–∞</span>
                        </div>
                        <p class="text-sm mt-2"><strong>–ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏:</strong> –∑–∞–±—ã–≤–∞—é—Ç <b>-s</b> —Å he/she/it, —Å—Ç–∞–≤—è—Ç am/is/are –ø–µ—Ä–µ–¥ –æ–±—ã—á–Ω—ã–º –≥–ª–∞–≥–æ–ª–æ–º –±–µ–∑ –ø—Ä–∏—á–∏–Ω—ã.</p>
                    </div>
                `,
                tasks: [
                    { id: "ps_mc_1", type: "mc", prompt: "She ___ coffee every morning.", options: ["drink", "drinks"], correct: 1, explanation: "She -> –≥–ª–∞–≥–æ–ª —Å -s: drinks." },
                    { id: "ps_mc_2", type: "mc", prompt: "They ___ in London.", options: ["live", "lives"], correct: 0, explanation: "They -> –±–∞–∑–æ–≤–∞—è —Ñ–æ—Ä–º–∞: live." },
                    { id: "ps_mc_3", type: "mc", prompt: "My brother ___ football on Fridays.", options: ["play", "plays"], correct: 1, explanation: "He -> plays." },
                    { id: "ps_mc_4", type: "mc", prompt: "We usually ___ dinner at 7.", options: ["have", "has"], correct: 0, explanation: "We -> have." },
                    { id: "ps_mc_5", type: "mc", prompt: "Tom ___ to school by bus.", options: ["go", "goes"], correct: 1, explanation: "Tom (he) -> goes." },
                    { id: "ps_mc_6", type: "mc", prompt: "I ___ TV in the evening.", options: ["watch", "watches"], correct: 0, explanation: "I -> watch." },
                    { id: "ps_mc_7", type: "mc", prompt: "The shop ___ at 9 a.m.", options: ["open", "opens"], correct: 1, explanation: "The shop (it) -> opens." },
                    { id: "ps_mc_8", type: "mc", prompt: "Cats ___ milk.", options: ["like", "likes"], correct: 0, explanation: "Cats (they) -> like." },
                    { id: "ps_mc_9", type: "mc", prompt: "Anna ___ her homework after school.", options: ["do", "does"], correct: 1, explanation: "Anna (she) -> does." },
                    { id: "ps_tf_1", type: "tf", prompt: "–í Present Simple —Å he/she/it —á–∞—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è -s –∫ –≥–ª–∞–≥–æ–ª—É.", correct: true, explanation: "–î–∞, —ç—Ç–æ –∫–ª—é—á–µ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ." },
                    { id: "ps_fill_1", type: "fill", prompt: "He ___ English every day. (study)", correct: "studies", acceptedAnswers: ["studies"], explanation: "–ü–æ—Å–ª–µ —Å–æ–≥–ª–∞—Å–Ω–æ–π + y: studies." },
                    { id: "ps_fill_2", type: "fill", prompt: "I ___ up at 6 a.m. (get)", correct: "get", acceptedAnswers: ["get"], explanation: "I -> –±–∞–∑–æ–≤–∞—è —Ñ–æ—Ä–º–∞ get." }
                ]
            },
            {
                id: 'present_continuous',
                title: "Present Continuous",
                icon: "fa-spinner",
                summary: "–î–µ–π—Å—Ç–≤–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å–µ–π—á–∞—Å –∏–ª–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ: now, right now, at the moment.",
                theory: `
                    <div class="bg-purple-50 p-5 rounded-xl mb-6 text-purple-900 border-l-4 border-purple-500 shadow-sm">
                        <h4 class="font-bold mb-2">–ö—Ä–∞—Ç–∫–æ</h4>
                        <p class="text-sm mb-2"><strong>Present Continuous</strong>: –ø—Ä–æ—Ü–µ—Å—Å –≤ –º–æ–º–µ–Ω—Ç —Ä–µ—á–∏ –∏–ª–∏ –≤—Ä–µ–º–µ–Ω–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è.</p>
                        <div class="bg-white border border-purple-200 rounded-lg p-3 text-sm mb-2">
                            <strong>–§–æ—Ä–º—É–ª–∞:</strong> am/is/are + V-ing
                        </div>
                        <p class="text-sm"><strong>–ü—Ä–∏–º–µ—Ä—ã:</strong> I am reading now. They are waiting at the bus stop.</p>
                        <p class="text-sm mt-2 mb-2"><strong>Time markers:</strong></p>
                        <div class="flex flex-wrap gap-2 mb-2">
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-purple-100 text-purple-800 border border-purple-200">now ‚Äî —Å–µ–π—á–∞—Å</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-purple-100 text-purple-800 border border-purple-200">right now ‚Äî –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-purple-100 text-purple-800 border border-purple-200">at the moment ‚Äî –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-purple-100 text-purple-800 border border-purple-200">currently ‚Äî –≤ –Ω–∞—Å—Ç–æ—è—â–µ–µ –≤—Ä–µ–º—è</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-purple-100 text-purple-800 border border-purple-200">today (temporary) ‚Äî —Å–µ–≥–æ–¥–Ω—è (–≤—Ä–µ–º–µ–Ω–Ω–æ)</span>
                        </div>
                        <p class="text-sm mt-2"><strong>–ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏:</strong> –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç am/is/are, –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç Present Continuous –¥–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö —Ñ–∞–∫—Ç–æ–≤.</p>
                    </div>
                `,
                tasks: [
                    { id: "pc_mc_1", type: "mc", prompt: "I ___ a book now.", options: ["read", "am reading"], correct: 1, explanation: "Now -> am reading." },
                    { id: "pc_mc_2", type: "mc", prompt: "She ___ TV at the moment.", options: ["is watching", "watches"], correct: 0, explanation: "At the moment -> is watching." },
                    { id: "pc_mc_3", type: "mc", prompt: "They ___ dinner right now.", options: ["are cooking", "cook"], correct: 0, explanation: "Right now -> are cooking." },
                    { id: "pc_mc_4", type: "mc", prompt: "We ___ for the teacher now.", options: ["wait", "are waiting"], correct: 1, explanation: "–ü—Ä–æ—Ü–µ—Å—Å —Å–µ–π—á–∞—Å -> are waiting." },
                    { id: "pc_mc_5", type: "mc", prompt: "Tom ___ on the phone now.", options: ["talks", "is talking"], correct: 1, explanation: "Tom -> is talking." },
                    { id: "pc_mc_6", type: "mc", prompt: "My parents ___ in the kitchen.", options: ["are eating", "eat"], correct: 0, explanation: "–î–µ–π—Å—Ç–≤–∏–µ –≤ –º–æ–º–µ–Ω—Ç —Ä–µ—á–∏ -> are eating." },
                    { id: "pc_mc_7", type: "mc", prompt: "It ___ outside now.", options: ["is raining", "rains"], correct: 0, explanation: "Now -> is raining." },
                    { id: "pc_mc_8", type: "mc", prompt: "You ___ very fast today.", options: ["run", "are running"], correct: 1, explanation: "–í—Ä–µ–º–µ–Ω–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è today -> are running." },
                    { id: "pc_mc_9", type: "mc", prompt: "The kids ___ in the yard now.", options: ["play", "are playing"], correct: 1, explanation: "Now -> are playing." },
                    { id: "pc_tf_1", type: "tf", prompt: "–í Present Continuous –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –µ—Å—Ç—å am/is/are + V-ing.", correct: true, explanation: "–î–∞, —ç—Ç–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞." },
                    { id: "pc_fill_1", type: "fill", prompt: "He ___ to music right now. (listen)", correct: "is listening", acceptedAnswers: ["is listening"], explanation: "He -> is listening." },
                    { id: "pc_fill_2", type: "fill", prompt: "We ___ for a taxi now. (wait)", correct: "are waiting", acceptedAnswers: ["are waiting"], explanation: "We -> are waiting." }
                ]
            },
            {
                id: 'past_simple',
                title: "Past Simple",
                icon: "fa-clock-rotate-left",
                summary: "–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –º–æ–º–µ–Ω—Ç –≤ –ø—Ä–æ—à–ª–æ–º: yesterday, last week, ago.",
                theory: `
                    <div class="bg-green-50 p-5 rounded-xl mb-6 text-green-900 border-l-4 border-green-500 shadow-sm">
                        <h4 class="font-bold mb-2">–ö—Ä–∞—Ç–∫–æ</h4>
                        <p class="text-sm mb-2"><strong>Past Simple</strong> –æ–ø–∏—Å—ã–≤–∞–µ—Ç —Ñ–∞–∫—Ç, –∫–æ—Ç–æ—Ä—ã–π –∑–∞–≤–µ—Ä—à–∏–ª—Å—è –≤ –ø—Ä–æ—à–ª–æ–º.</p>
                        <div class="bg-white border border-green-200 rounded-lg p-3 text-sm mb-2">
                            <strong>–§–æ—Ä–º—É–ª–∞:</strong> V2 / did + V1 (–≤ –≤–æ–ø—Ä–æ—Å–∞—Ö –∏ –æ—Ç—Ä–∏—Ü–∞–Ω–∏—è—Ö)
                        </div>
                        <p class="text-sm"><strong>–ü—Ä–∏–º–µ—Ä—ã:</strong> I visited my grandma yesterday. Did you call him?</p>
                        <p class="text-sm mt-2 mb-2"><strong>Time markers:</strong></p>
                        <div class="flex flex-wrap gap-2 mb-2">
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-green-100 text-green-800 border border-green-200">yesterday ‚Äî –≤—á–µ—Ä–∞</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-green-100 text-green-800 border border-green-200">last week ‚Äî –Ω–∞ –ø—Ä–æ—à–ª–æ–π –Ω–µ–¥–µ–ª–µ</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-green-100 text-green-800 border border-green-200">ago ‚Äî –Ω–∞–∑–∞–¥</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-green-100 text-green-800 border border-green-200">in 2021 ‚Äî –≤ 2021 –≥–æ–¥—É</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-green-100 text-green-800 border border-green-200">last night ‚Äî –ø—Ä–æ—à–ª–æ–π –Ω–æ—á—å—é</span>
                        </div>
                        <p class="text-sm mt-2"><strong>–ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏:</strong> —Å—Ç–∞–≤—è—Ç did + V2, –∑–∞–±—ã–≤–∞—é—Ç –º–∞—Ä–∫–µ—Ä—ã –ø—Ä–æ—à–ª–æ–≥–æ.</p>
                    </div>
                `,
                tasks: [
                    { id: "past_mc_1", type: "mc", prompt: "I ___ him yesterday.", options: ["see", "saw"], correct: 1, explanation: "Yesterday -> saw." },
                    { id: "past_mc_2", type: "mc", prompt: "They ___ tennis last Sunday.", options: ["played", "play"], correct: 0, explanation: "Last Sunday -> played." },
                    { id: "past_mc_3", type: "mc", prompt: "She ___ to Paris in 2021.", options: ["went", "go"], correct: 0, explanation: "In 2021 -> went." },
                    { id: "past_mc_4", type: "mc", prompt: "We ___ dinner two hours ago.", options: ["have", "had"], correct: 1, explanation: "Ago -> had." },
                    { id: "past_mc_5", type: "mc", prompt: "Tom ___ me last night.", options: ["called", "calls"], correct: 0, explanation: "Last night -> called." },
                    { id: "past_mc_6", type: "mc", prompt: "My sister ___ the window.", options: ["opened", "opens"], correct: 0, explanation: "–ó–∞–≤–µ—Ä—à–µ–Ω–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –≤ –ø—Ä–æ—à–ª–æ–º -> opened." },
                    { id: "past_mc_7", type: "mc", prompt: "We ___ the movie yesterday evening.", options: ["watched", "watch"], correct: 0, explanation: "Yesterday evening -> watched." },
                    { id: "past_mc_8", type: "mc", prompt: "He ___ breakfast at 8 a.m. yesterday.", options: ["ate", "eats"], correct: 0, explanation: "–ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –≤—Ä–µ–º—è –≤ –ø—Ä–æ—à–ª–æ–º -> ate." },
                    { id: "past_mc_9", type: "mc", prompt: "I ___ my keys an hour ago.", options: ["lost", "lose"], correct: 0, explanation: "An hour ago -> lost." },
                    { id: "past_tf_1", type: "tf", prompt: "–í –≤–æ–ø—Ä–æ—Å–µ —Å did –æ—Å–Ω–æ–≤–Ω–æ–π –≥–ª–∞–≥–æ–ª –∏–¥–µ—Ç –≤ V1.", correct: true, explanation: "–í–µ—Ä–Ω–æ: Did you go...?" },
                    { id: "past_fill_1", type: "fill", prompt: "She ___ me last week. (help)", correct: "helped", acceptedAnswers: ["helped"], explanation: "Last week -> helped." },
                    { id: "past_fill_2", type: "fill", prompt: "We ___ home late yesterday. (come)", correct: "came", acceptedAnswers: ["came"], explanation: "–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≥–ª–∞–≥–æ–ª: came." }
                ]
            },
            {
                id: 'past_continuous',
                title: "Past Continuous",
                icon: "fa-wave-square",
                summary: "–î–µ–π—Å—Ç–≤–∏–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –≤ –ø—Ä–æ—à–ª–æ–º: was/were + V-ing, —Ñ–æ–Ω –∏ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ.",
                theory: `
                    <div class="bg-emerald-50 p-5 rounded-xl mb-6 text-emerald-900 border-l-4 border-emerald-500 shadow-sm">
                        <h4 class="font-bold mb-2">–ö—Ä–∞—Ç–∫–æ</h4>
                        <p class="text-sm mb-2"><strong>Past Continuous</strong> –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–µ–π—Å—Ç–≤–∏–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –º–æ–º–µ–Ω—Ç –≤ –ø—Ä–æ—à–ª–æ–º.</p>
                        <div class="bg-white border border-emerald-200 rounded-lg p-3 text-sm mb-2">
                            <strong>Form:</strong> was/were + V-ing
                        </div>
                        <div class="bg-white border border-emerald-200 rounded-lg p-3 text-sm mb-2">
                            <strong>Usage:</strong> –¥–µ–π—Å—Ç–≤–∏–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –≤ –ø—Ä–æ—à–ª–æ–º; —Ñ–æ–Ω–æ–≤–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ + –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ –≤ Past Simple.
                        </div>
                        <p class="text-sm mt-2 mb-2"><strong>Time markers:</strong></p>
                        <div class="flex flex-wrap gap-2 mb-2">
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-emerald-100 text-emerald-800 border border-emerald-200">while</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-emerald-100 text-emerald-800 border border-emerald-200">when</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-emerald-100 text-emerald-800 border border-emerald-200">at 5 pm yesterday</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-emerald-100 text-emerald-800 border border-emerald-200">at that moment</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-emerald-100 text-emerald-800 border border-emerald-200">all day yesterday</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-emerald-100 text-emerald-800 border border-emerald-200">all night</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-emerald-100 text-emerald-800 border border-emerald-200">from 3 to 5</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-emerald-100 text-emerald-800 border border-emerald-200">as (= while)</span>
                        </div>
                    </div>
                `,
                tasks: [
                    { id: "pcon_mc_1", type: "mc", prompt: "At 5 pm yesterday, I ___ dinner.", options: ["was cooking", "cooked"], correct: 0, explanation: "–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –º–æ–º–µ–Ω—Ç –≤ –ø—Ä–æ—à–ª–æ–º + –ø—Ä–æ—Ü–µ—Å—Å -> was cooking." },
                    { id: "pcon_mc_2", type: "mc", prompt: "When mom came home, we ___ TV.", options: ["were watching", "watched"], correct: 0, explanation: "–§–æ–Ω –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ + –∫–æ—Ä–æ—Ç–∫–æ–µ —Å–æ–±—ã—Ç–∏–µ -> were watching." },
                    { id: "pcon_mc_3", type: "mc", prompt: "While I ___, the phone rang.", options: ["was studying", "studied"], correct: 0, explanation: "–î–ª–∏—Ç–µ–ª—å–Ω–æ–µ —Ñ–æ–Ω–æ–≤–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ -> was studying." },
                    { id: "pcon_mc_4", type: "mc", prompt: "While Tom was driving, Anna ___ the map.", options: ["was reading", "read"], correct: 0, explanation: "–î–≤–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–∞ —Å while -> was reading." },
                    { id: "pcon_mc_5", type: "mc", prompt: "They ___ football while it was raining.", options: ["were playing", "played"], correct: 0, explanation: "–î–µ–π—Å—Ç–≤–∏–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –≤ –ø—Ä–æ—à–ª–æ–º -> were playing." },
                    { id: "pcon_mc_6", type: "mc", prompt: "She ___ at 8 pm; she was sleeping.", options: ["wasn't working", "didn't work"], correct: 0, explanation: "–û—Ç—Ä–∏—Ü–∞–Ω–∏–µ Past Continuous: wasn't working." },
                    { id: "pcon_mc_7", type: "mc", prompt: "___ you sleeping at midnight?", options: ["Were", "Did"], correct: 0, explanation: "–í–æ–ø—Ä–æ—Å –≤ Past Continuous: Were you ...?" },
                    { id: "pcon_mc_8", type: "mc", prompt: "I ___ not listening when you called.", options: ["was", "did"], correct: 0, explanation: "I was not listening." },
                    { id: "pcon_mc_9", type: "mc", prompt: "At that moment, the children ___ in the yard.", options: ["were playing", "played"], correct: 0, explanation: "At that moment -> were playing." },
                    { id: "pcon_tf_1", type: "tf", prompt: "Past Continuous —á–∞—Å—Ç–æ –æ–ø–∏—Å—ã–≤–∞–µ—Ç —Ñ–æ–Ω, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç—Å—è –¥–µ–π—Å—Ç–≤–∏–µ–º –≤ Past Simple.", correct: true, explanation: "–î–∞: I was reading when he called." },
                    { id: "pcon_fill_1", type: "fill", prompt: "We ___ from 3 to 5 yesterday. (study)", correct: "were studying", acceptedAnswers: ["were studying"], explanation: "From 3 to 5 -> –ø—Ä–æ—Ü–µ—Å—Å –≤ –ø—Ä–æ—à–ª–æ–º." },
                    { id: "pcon_fill_2", type: "fill", prompt: "He ___ when I saw him. (run)", correct: "was running", acceptedAnswers: ["was running"], explanation: "run -> running, –ø—Ä–æ—Ü–µ—Å—Å –≤ –ø—Ä–æ—à–ª–æ–º -> was running." }
                ]
            },
            {
                id: 'future_simple',
                title: "Future Simple / will",
                icon: "fa-forward",
                summary: "–†–µ—à–µ–Ω–∏–µ –≤ –º–æ–º–µ–Ω—Ç —Ä–µ—á–∏, –æ–±–µ—â–∞–Ω–∏–µ, –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ: will + V1.",
                theory: `
                    <div class="bg-yellow-50 p-5 rounded-xl mb-6 text-yellow-900 border-l-4 border-yellow-500 shadow-sm">
                        <h4 class="font-bold mb-2">–ö—Ä–∞—Ç–∫–æ</h4>
                        <p class="text-sm mb-2"><strong>Future Simple</strong> = <b>will + –≥–ª–∞–≥–æ–ª</b>. –î–ª—è —Ä–µ—à–µ–Ω–∏–π, –æ–±–µ—â–∞–Ω–∏–π –∏ –ø—Ä–æ–≥–Ω–æ–∑–æ–≤.</p>
                        <div class="bg-white border border-yellow-200 rounded-lg p-3 text-sm mb-2">
                            <strong>–§–æ—Ä–º—É–ª–∞:</strong> will + V1
                        </div>
                        <p class="text-sm"><strong>–ü—Ä–∏–º–µ—Ä—ã:</strong> I will help you. It will rain tomorrow.</p>
                        <p class="text-sm mt-2 mb-2"><strong>Time markers:</strong></p>
                        <div class="flex flex-wrap gap-2 mb-2">
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-900 border border-yellow-200">tomorrow ‚Äî –∑–∞–≤—Ç—Ä–∞</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-900 border border-yellow-200">soon ‚Äî —Å–∫–æ—Ä–æ</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-900 border border-yellow-200">tonight ‚Äî —Å–µ–≥–æ–¥–Ω—è –≤–µ—á–µ—Ä–æ–º</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-900 border border-yellow-200">next week ‚Äî –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–π –Ω–µ–¥–µ–ª–µ</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-900 border border-yellow-200">I think ‚Äî —è –¥—É–º–∞—é</span>
                        </div>
                        <p class="text-sm mt-2"><strong>–ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏:</strong> —Å—Ç–∞–≤—è—Ç will + V2 –∏–ª–∏ will + to V1.</p>
                    </div>
                `,
                tasks: [
                    { id: "fut_mc_1", type: "mc", prompt: "I ___ call you tonight.", options: ["will", "am"], correct: 0, explanation: "Future Simple: will call." },
                    { id: "fut_mc_2", type: "mc", prompt: "She ___ help us tomorrow.", options: ["will", "does"], correct: 0, explanation: "Tomorrow -> will help." },
                    { id: "fut_mc_3", type: "mc", prompt: "They ___ be late, I think.", options: ["will", "are"], correct: 0, explanation: "–ü—Ä–æ–≥–Ω–æ–∑ -> will be." },
                    { id: "fut_mc_4", type: "mc", prompt: "We ___ start at 9.", options: ["will", "did"], correct: 0, explanation: "–ü–ª–∞–Ω —Ä–µ—à–µ–Ω–∏—è -> will start." },
                    { id: "fut_mc_5", type: "mc", prompt: "It ___ snow tomorrow.", options: ["will", "is"], correct: 0, explanation: "–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –∑–∞–≤—Ç—Ä–∞ -> will snow." },
                    { id: "fut_mc_6", type: "mc", prompt: "I promise I ___ forget.", options: ["won't", "don't"], correct: 0, explanation: "–û—Ç—Ä–∏—Ü–∞–Ω–∏–µ –≤ –±—É–¥—É—â–µ–º: won't." },
                    { id: "fut_mc_7", type: "mc", prompt: "He ___ answer your email soon.", options: ["will", "has"], correct: 0, explanation: "Soon -> will answer." },
                    { id: "fut_mc_8", type: "mc", prompt: "___ you help me?", options: ["Will", "Did"], correct: 0, explanation: "–í–µ–∂–ª–∏–≤–∞—è –ø—Ä–æ—Å—å–±–∞: Will you...?" },
                    { id: "fut_mc_9", type: "mc", prompt: "The team ___ win this match.", options: ["will", "wins"], correct: 0, explanation: "–ü—Ä–æ–≥–Ω–æ–∑ -> will win." },
                    { id: "fut_tf_1", type: "tf", prompt: "–ü–æ—Å–ª–µ will –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–∞–∑–æ–≤–∞—è —Ñ–æ—Ä–º–∞ –≥–ª–∞–≥–æ–ª–∞ (V1).", correct: true, explanation: "–î–∞: will go, will do, will see." },
                    { id: "fut_fill_1", type: "fill", prompt: "I ___ you tomorrow. (text)", correct: "will text", acceptedAnswers: ["will text", "i will text"], explanation: "Future Simple: will text." },
                    { id: "fut_fill_2", type: "fill", prompt: "We ___ late. (not be)", correct: "won't be", acceptedAnswers: ["won't be", "will not be"], explanation: "–û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è —Ñ–æ—Ä–º–∞: won't be." }
                ]
            },
            {
                id: 'present_perfect',
                title: "Present Perfect",
                icon: "fa-check-double",
                summary: "–û–ø—ã—Ç –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫ –Ω–∞—Å—Ç–æ—è—â–µ–º—É: have/has + V3, already/yet/ever/never.",
                theory: `
                    <div class="bg-red-50 p-5 rounded-xl mb-6 text-red-900 border-l-4 border-red-500 shadow-sm">
                        <h4 class="font-bold mb-2">–ö—Ä–∞—Ç–∫–æ</h4>
                        <p class="text-sm mb-2"><strong>Present Perfect</strong> —Å–≤—è–∑—ã–≤–∞–µ—Ç –ø—Ä–æ—à–ª–æ–µ –∏ –Ω–∞—Å—Ç–æ—è—â–µ–µ: –≤–∞–∂–µ–Ω —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–µ–π—á–∞—Å.</p>
                        <div class="bg-white border border-red-200 rounded-lg p-3 text-sm mb-2">
                            <strong>–§–æ—Ä–º—É–ª–∞:</strong> have/has + V3
                        </div>
                        <p class="text-sm"><strong>–ü—Ä–∏–º–µ—Ä—ã:</strong> I have finished my work. She has never tried sushi.</p>
                        <p class="text-sm mt-2 mb-2"><strong>Time markers:</strong></p>
                        <div class="flex flex-wrap gap-2 mb-2">
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-red-100 text-red-800 border border-red-200">already ‚Äî —É–∂–µ</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-red-100 text-red-800 border border-red-200">yet ‚Äî –µ—â–µ (–≤–æ–ø—Ä–æ—Å/–æ—Ç—Ä–∏—Ü.)</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-red-100 text-red-800 border border-red-200">ever ‚Äî –∫–æ–≥–¥–∞-–ª–∏–±–æ</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-red-100 text-red-800 border border-red-200">never ‚Äî –Ω–∏–∫–æ–≥–¥–∞</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-red-100 text-red-800 border border-red-200">just ‚Äî —Ç–æ–ª—å–∫–æ —á—Ç–æ</span>
                        </div>
                        <p class="text-sm mt-2"><strong>–ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏:</strong> –∏—Å–ø–æ–ª—å–∑—É—é—Ç Present Perfect —Å —Ç–æ—á–Ω—ã–º –≤—Ä–µ–º–µ–Ω–µ–º (yesterday, in 2020).</p>
                    </div>
                `,
                tasks: [
                    { id: "pp_mc_1", type: "mc", prompt: "I ___ my homework already.", options: ["finished", "have finished"], correct: 1, explanation: "Already -> have finished." },
                    { id: "pp_mc_2", type: "mc", prompt: "She ___ never been to Spain.", options: ["has", "is"], correct: 0, explanation: "She -> has never been." },
                    { id: "pp_mc_3", type: "mc", prompt: "___ you ever tried ramen?", options: ["Did", "Have"], correct: 1, explanation: "–û–ø—ã—Ç -> Have you ever...?" },
                    { id: "pp_mc_4", type: "mc", prompt: "They ___ just arrived.", options: ["have", "did"], correct: 0, explanation: "Just -> have arrived." },
                    { id: "pp_mc_5", type: "mc", prompt: "He ___ his keys.", options: ["has lost", "lost"], correct: 0, explanation: "–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–µ–π—á–∞—Å -> has lost." },
                    { id: "pp_mc_6", type: "mc", prompt: "We ___ this movie before.", options: ["have seen", "saw"], correct: 0, explanation: "Before/–æ–ø—ã—Ç -> have seen." },
                    { id: "pp_mc_7", type: "mc", prompt: "I ___ not finished yet.", options: ["have", "am"], correct: 0, explanation: "Yet -> have not finished." },
                    { id: "pp_mc_8", type: "mc", prompt: "Tom ___ already eaten.", options: ["has", "did"], correct: 0, explanation: "Tom -> has eaten." },
                    { id: "pp_mc_9", type: "mc", prompt: "My parents ___ to Italy twice.", options: ["have been", "went"], correct: 0, explanation: "–û–ø—ã—Ç (twice) -> have been." },
                    { id: "pp_tf_1", type: "tf", prompt: "–í Present Perfect –æ–±—ã—á–Ω–æ –Ω–µ—Ç —Ç–æ—á–Ω–æ–≥–æ —É–∫–∞–∑–∞–Ω–∏—è –ø—Ä–æ—à–ª–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ —Ç–∏–ø–∞ 'yesterday'.", correct: true, explanation: "–î–∞, —ç—Ç–æ —Ç–∏–ø–∏—á–Ω–∞—è –≥—Ä–∞–Ω–∏—Ü–∞ —Å Past Simple." },
                    { id: "pp_fill_1", type: "fill", prompt: "She has ___ her room. (clean)", correct: "cleaned", acceptedAnswers: ["cleaned"], explanation: "V3 –æ—Ç clean: cleaned." },
                    { id: "pp_fill_2", type: "fill", prompt: "I have ___ this book before. (read)", correct: "read", acceptedAnswers: ["read"], explanation: "V3 read –ø–∏—à–µ—Ç—Å—è —Ç–∞–∫ –∂–µ." }
                ]
            },
            {
                id: 'mix_ps_pc',
                title: "Mixed: Present Simple vs Present Continuous",
                icon: "fa-code-branch",
                summary: "–ü—Ä–∏–≤—ã—á–∫–∞/—Ñ–∞–∫—Ç vs –¥–µ–π—Å—Ç–≤–∏–µ —Å–µ–π—á–∞—Å –∏–ª–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ.",
                theory: `
                    <div class="bg-cyan-50 p-5 rounded-xl mb-6 text-cyan-900 border-l-4 border-cyan-500 shadow-sm">
                        <h4 class="font-bold mb-2">–ö—Ä–∞—Ç–∫–æ</h4>
                        <p class="text-sm mb-2"><strong>Present Simple vs Present Continuous:</strong> –æ–±—ã—á–Ω–æ–µ –∏ —Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ vs –ø—Ä–æ—Ü–µ—Å—Å —Å–µ–π—á–∞—Å/–≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥.</p>
                        <p class="text-sm mt-2 mb-2"><strong>Time markers:</strong></p>
                        <div class="flex flex-wrap gap-2 mb-2">
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-cyan-100 text-cyan-800 border border-cyan-200">every day</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-cyan-100 text-cyan-800 border border-cyan-200">usually</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-cyan-100 text-cyan-800 border border-cyan-200">now</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-cyan-100 text-cyan-800 border border-cyan-200">right now</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-cyan-100 text-cyan-800 border border-cyan-200">these days</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-cyan-100 text-cyan-800 border border-cyan-200">nowadays</span>
                        </div>
                    </div>
                `,
                tasks: [
                    { id: "mix_pspc_mc_1", type: "mc", prompt: "She usually ___ tea, but now she ___ coffee.", options: ["drinks / is drinking", "is drinking / drinks"], correct: 0, explanation: "Usually -> Present Simple, now -> Present Continuous." },
                    { id: "mix_pspc_mc_2", type: "mc", prompt: "I ___ to work by bus every day.", options: ["go", "am going"], correct: 0, explanation: "Every day -> Present Simple." },
                    { id: "mix_pspc_mc_3", type: "mc", prompt: "Look! The baby ___.", options: ["cries", "is crying"], correct: 1, explanation: "Look! -> –ø—Ä–æ—Ü–µ—Å—Å —Å–µ–π—á–∞—Å." },
                    { id: "mix_pspc_mc_4", type: "mc", prompt: "People ___ smartphones nowadays.", options: ["use", "are using"], correct: 0, explanation: "Nowadays -> –æ–±—â–∏–π —Ñ–∞–∫—Ç." },
                    { id: "mix_pspc_mc_5", type: "mc", prompt: "I'm working late these days.", options: ["Present Continuous", "Present Simple"], correct: 0, explanation: "These days -> –≤—Ä–µ–º–µ–Ω–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è." },
                    { id: "mix_pspc_mc_6", type: "mc", prompt: "He ___ football on Sundays.", options: ["plays", "is playing"], correct: 0, explanation: "On Sundays -> –ø—Ä–∏–≤—ã—á–∫–∞." },
                    { id: "mix_pspc_mc_7", type: "mc", prompt: "We ___ for Anna at the moment.", options: ["wait", "are waiting"], correct: 1, explanation: "At the moment -> –ø—Ä–æ—Ü–µ—Å—Å." },
                    { id: "mix_pspc_mc_8", type: "mc", prompt: "My brother ___ at a cafe this month.", options: ["works", "is working"], correct: 1, explanation: "–í—Ä–µ–º–µ–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ -> is working." },
                    { id: "mix_pspc_mc_9", type: "mc", prompt: "Water ___ at 100 C.", options: ["boils", "is boiling"], correct: 0, explanation: "–ù–∞—É—á–Ω—ã–π —Ñ–∞–∫—Ç -> Present Simple." },
                    { id: "mix_pspc_tf_1", type: "tf", prompt: "'Now' —á–∞—â–µ —Ç—Ä–µ–±—É–µ—Ç Present Continuous.", correct: true, explanation: "–î–∞, —ç—Ç–æ –º–∞—Ä–∫–µ—Ä –¥–µ–π—Å—Ç–≤–∏—è –≤ –º–æ–º–µ–Ω—Ç —Ä–µ—á–∏." },
                    { id: "mix_pspc_fill_1", type: "fill", prompt: "She ___ her homework now. (do)", correct: "is doing", acceptedAnswers: ["is doing"], explanation: "Now -> is doing." },
                    { id: "mix_pspc_fill_2", type: "fill", prompt: "He ___ coffee every morning. (drink)", correct: "drinks", acceptedAnswers: ["drinks"], explanation: "Every morning -> drinks." }
                ]
            },
            {
                id: 'mix_past_simple_past_continuous',
                title: "Mixed: Past Simple vs Past Continuous",
                icon: "fa-arrows-left-right",
                summary: "–ö–æ—Ä–æ—Ç–∫–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ vs –ø—Ä–æ—Ü–µ—Å—Å –≤ –ø—Ä–æ—à–ª–æ–º.",
                theory: `
                    <div class="bg-teal-50 p-5 rounded-xl mb-6 text-teal-900 border-l-4 border-teal-500 shadow-sm">
                        <h4 class="font-bold mb-2">–ö—Ä–∞—Ç–∫–æ</h4>
                        <p class="text-sm mb-2"><strong>Past Simple vs Past Continuous:</strong> finished event vs background action in progress.</p>
                        <p class="text-sm mt-2 mb-2"><strong>Time markers:</strong></p>
                        <div class="flex flex-wrap gap-2 mb-2">
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-teal-100 text-teal-800 border border-teal-200">yesterday</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-teal-100 text-teal-800 border border-teal-200">ago</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-teal-100 text-teal-800 border border-teal-200">while</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-teal-100 text-teal-800 border border-teal-200">when</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-teal-100 text-teal-800 border border-teal-200">at that moment</span>
                        </div>
                    </div>
                `,
                tasks: [
                    { id: "mix_pastc_mc_1", type: "mc", prompt: "I ___ dinner when he called.", options: ["was cooking", "cooked"], correct: 0, explanation: "–§–æ–Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å + –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ." },
                    { id: "mix_pastc_mc_2", type: "mc", prompt: "She ___ me yesterday evening.", options: ["called", "was calling"], correct: 0, explanation: "–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π —Ñ–∞–∫—Ç -> Past Simple." },
                    { id: "mix_pastc_mc_3", type: "mc", prompt: "While they ___, the lights went out.", options: ["were talking", "talked"], correct: 0, explanation: "While + –ø—Ä–æ—Ü–µ—Å—Å -> were talking." },
                    { id: "mix_pastc_mc_4", type: "mc", prompt: "At 9 pm, we ___ TV.", options: ["were watching", "watched"], correct: 0, explanation: "–¢–æ—á–Ω—ã–π –º–æ–º–µ–Ω—Ç + –ø—Ä–æ—Ü–µ—Å—Å." },
                    { id: "mix_pastc_mc_5", type: "mc", prompt: "He ___ his phone an hour ago.", options: ["lost", "was losing"], correct: 0, explanation: "An hour ago -> Past Simple." },
                    { id: "mix_pastc_mc_6", type: "mc", prompt: "When the teacher came in, students ___.", options: ["were writing", "wrote"], correct: 0, explanation: "–§–æ–Ω –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ -> were writing." },
                    { id: "mix_pastc_mc_7", type: "mc", prompt: "We ___ for two hours yesterday.", options: ["walked", "were walking"], correct: 1, explanation: "–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ –ø—Ä–æ—à–ª–æ–º –∫–∞–∫ –ø—Ä–æ—Ü–µ—Å—Å." },
                    { id: "mix_pastc_mc_8", type: "mc", prompt: "They ___ home late last night.", options: ["came", "were coming"], correct: 0, explanation: "–ó–∞–≤–µ—Ä—à–µ–Ω–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ." },
                    { id: "mix_pastc_mc_9", type: "mc", prompt: "As I ___ home, it started to snow.", options: ["was walking", "walked"], correct: 0, explanation: "as = while -> –ø—Ä–æ—Ü–µ—Å—Å." },
                    { id: "mix_pastc_tf_1", type: "tf", prompt: "–í –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ 'while ...' —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Past Continuous –¥–ª—è —Ñ–æ–Ω–æ–≤–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è.", correct: true, explanation: "–î–∞, —ç—Ç–æ —Ç–∏–ø–∏—á–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω." },
                    { id: "mix_pastc_fill_1", type: "fill", prompt: "She ___ when I opened the door. (sleep)", correct: "was sleeping", acceptedAnswers: ["was sleeping"], explanation: "–§–æ–Ω -> was sleeping." },
                    { id: "mix_pastc_fill_2", type: "fill", prompt: "We ___ football yesterday. (play)", correct: "played", acceptedAnswers: ["played"], explanation: "–í—á–µ—Ä–∞, —Ñ–∞–∫—Ç -> played." }
                ]
            },
            {
                id: 'mix_present_perfect_past_simple',
                title: "Mixed: Present Perfect vs Past Simple",
                icon: "fa-shuffle",
                summary: "–û–ø—ã—Ç/—Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫ –Ω–∞—Å—Ç–æ—è—â–µ–º—É vs –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π —Ñ–∞–∫—Ç –≤ –ø—Ä–æ—à–ª–æ–º.",
                theory: `
                    <div class="bg-rose-50 p-5 rounded-xl mb-6 text-rose-900 border-l-4 border-rose-500 shadow-sm">
                        <h4 class="font-bold mb-2">–ö—Ä–∞—Ç–∫–æ</h4>
                        <p class="text-sm mb-2"><strong>Present Perfect vs Past Simple:</strong> —Å–≤—è–∑—å —Å –Ω–∞—Å—Ç–æ—è—â–∏–º (have/has + V3) vs –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –ø—Ä–æ—à–ª–æ–µ –≤—Ä–µ–º—è (V2).</p>
                        <p class="text-sm mt-2 mb-2"><strong>Time markers:</strong></p>
                        <div class="flex flex-wrap gap-2 mb-2">
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-rose-100 text-rose-800 border border-rose-200">already / yet / ever / never</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-rose-100 text-rose-800 border border-rose-200">yesterday / ago / in 2020</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-rose-100 text-rose-800 border border-rose-200">today so far vs today at 9 AM</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-rose-100 text-rose-800 border border-rose-200">this week so far vs on Monday</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-rose-100 text-rose-800 border border-rose-200">recently (context)</span>
                        </div>
                    </div>
                `,
                tasks: [
                    { id: "mix_pppast_mc_1", type: "mc", prompt: "I ___ him yesterday.", options: ["saw", "have seen"], correct: 0, explanation: "Yesterday -> Past Simple." },
                    { id: "mix_pppast_mc_2", type: "mc", prompt: "I ___ him recently. (life experience)", options: ["have seen", "saw"], correct: 0, explanation: "Recently –∫–∞–∫ –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –æ–ø—ã—Ç -> Present Perfect." },
                    { id: "mix_pppast_mc_3", type: "mc", prompt: "I ___ him recently at the mall.", options: ["have seen", "saw"], correct: 1, explanation: "–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π —ç–ø–∏–∑–æ–¥ -> Past Simple." },
                    { id: "mix_pppast_mc_4", type: "mc", prompt: "She ___ her homework already.", options: ["has finished", "finished"], correct: 0, explanation: "Already -> Present Perfect." },
                    { id: "mix_pppast_mc_5", type: "mc", prompt: "We ___ this week on Monday.", options: ["studied", "have studied"], correct: 0, explanation: "Finished event with Monday -> Past Simple." },
                    { id: "mix_pppast_mc_6", type: "mc", prompt: "We ___ a lot this week.", options: ["have studied", "studied"], correct: 0, explanation: "This week so far -> Present Perfect." },
                    { id: "mix_pppast_mc_7", type: "mc", prompt: "___ you ever tried sushi?", options: ["Have", "Did"], correct: 0, explanation: "–û–ø—ã—Ç –±–µ–∑ –≤—Ä–µ–º–µ–Ω–∏ -> Have you ever...?" },
                    { id: "mix_pppast_mc_8", type: "mc", prompt: "He ___ in 2019.", options: ["went", "has gone"], correct: 0, explanation: "In 2019 -> Past Simple." },
                    { id: "mix_pppast_mc_9", type: "mc", prompt: "I ___ three emails today so far.", options: ["have sent", "sent"], correct: 0, explanation: "Today so far -> Present Perfect." },
                    { id: "mix_pppast_tf_1", type: "tf", prompt: "–°–ª–æ–≤–∞ 'yesterday' –∏ 'in 2020' –æ–±—ã—á–Ω–æ –Ω–µ —Å–æ—á–µ—Ç–∞—é—Ç—Å—è —Å Present Perfect.", correct: true, explanation: "–î–∞, —ç—Ç–æ –º–∞—Ä–∫–µ—Ä—ã Past Simple." },
                    { id: "mix_pppast_fill_1", type: "fill", prompt: "She ___ her keys an hour ago. (lose)", correct: "lost", acceptedAnswers: ["lost"], explanation: "An hour ago -> Past Simple." },
                    { id: "mix_pppast_fill_2", type: "fill", prompt: "They ___ the report already. (finish)", correct: "have finished", acceptedAnswers: ["have finished"], explanation: "Already -> Present Perfect." }
                ]
            },
            {
                id: 'mixed_all',
                title: "Mixed Practice: All Tenses",
                icon: "fa-layer-group",
                summary: "–í—Å–µ —à–µ—Å—Ç—å –≤—Ä–µ–º–µ–Ω –≤ –æ–¥–Ω–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ.",
                theory: `
                    <div class="bg-indigo-50 p-5 rounded-xl mb-6 text-indigo-900 border-l-4 border-indigo-500 shadow-sm">
                        <h4 class="font-bold mb-2">–ö—Ä–∞—Ç–∫–æ</h4>
                        <p class="text-sm mb-2">–°–º–æ—Ç—Ä–∏ –Ω–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç: <strong>–ø—Ä–∏–≤—ã—á–∫–∞, —Å–µ–π—á–∞—Å, –ø—Ä–æ—à–ª—ã–π —Ñ–∞–∫—Ç, —Ñ–æ–Ω –≤ –ø—Ä–æ—à–ª–æ–º, –±—É–¥—É—â–µ–µ, —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫ –Ω–∞—Å—Ç–æ—è—â–µ–º—É</strong>.</p>
                        <p class="text-sm mt-2 mb-2"><strong>Time markers:</strong></p>
                        <div class="flex flex-wrap gap-2 mb-2">
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-indigo-100 text-indigo-800 border border-indigo-200">every day</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-indigo-100 text-indigo-800 border border-indigo-200">right now</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-indigo-100 text-indigo-800 border border-indigo-200">yesterday</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-indigo-100 text-indigo-800 border border-indigo-200">while / at that moment</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-indigo-100 text-indigo-800 border border-indigo-200">tomorrow / I think</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-indigo-100 text-indigo-800 border border-indigo-200">already / ever / yet</span>
                        </div>
                    </div>
                `,
                tasks: [
                    { id: "mixa_mc_1", type: "mc", prompt: "I usually ___ at 6 a.m.", options: ["get up", "am getting up"], correct: 0, explanation: "Usually -> Present Simple." },
                    { id: "mixa_mc_2", type: "mc", prompt: "She ___ a shower now.", options: ["has", "is having"], correct: 1, explanation: "Now -> Present Continuous." },
                    { id: "mixa_mc_3", type: "mc", prompt: "We ___ them last weekend.", options: ["met", "have met"], correct: 0, explanation: "Last weekend -> Past Simple." },
                    { id: "mixa_mc_4", type: "mc", prompt: "At that moment, they ___ dinner.", options: ["were having", "had"], correct: 0, explanation: "At that moment -> Past Continuous." },
                    { id: "mixa_mc_5", type: "mc", prompt: "I ___ finish this tomorrow, I promise.", options: ["will", "am"], correct: 0, explanation: "–û–±–µ—â–∞–Ω–∏–µ -> will finish." },
                    { id: "mixa_mc_6", type: "mc", prompt: "He ___ already ___ the message.", options: ["has / sent", "did / send"], correct: 0, explanation: "Already -> Present Perfect." },
                    { id: "mixa_mc_7", type: "mc", prompt: "While I was driving, my friend ___ to music.", options: ["was listening", "listened"], correct: 0, explanation: "–î–≤–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–∞ –≤ –ø—Ä–æ—à–ª–æ–º." },
                    { id: "mixa_mc_8", type: "mc", prompt: "My dad ___ that film in 2018.", options: ["saw", "has seen"], correct: 0, explanation: "In 2018 -> Past Simple." },
                    { id: "mixa_mc_9", type: "mc", prompt: "People ___ online shopping nowadays.", options: ["prefer", "are preferring"], correct: 0, explanation: "Nowadays -> Present Simple." },
                    { id: "mixa_tf_1", type: "tf", prompt: "–ú–∞—Ä–∫–µ—Ä 'while' —á–∞—Å—Ç–æ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ Past Continuous –≤ —Ñ–æ–Ω–æ–≤–æ–π —á–∞—Å—Ç–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è.", correct: true, explanation: "–î–∞, –æ—Å–æ–±–µ–Ω–Ω–æ –≤ —Å–æ—á–µ—Ç–∞–Ω–∏–∏ —Å –∫–æ—Ä–æ—Ç–∫–∏–º –¥–µ–π—Å—Ç–≤–∏–µ–º –≤ Past Simple." },
                    { id: "mixa_fill_1", type: "fill", prompt: "She ___ to school every day. (go)", correct: "goes", acceptedAnswers: ["goes"], explanation: "Every day -> Present Simple." },
                    { id: "mixa_fill_2", type: "fill", prompt: "We ___ for two hours yesterday evening. (work)", correct: "were working", acceptedAnswers: ["were working"], explanation: "–î–ª–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å –≤ –ø—Ä–æ—à–ª–æ–º." }
                ]
            }
        ];

        const studyPlan = [
            { day: 1, title: "Day 1: Time Markers", task: "–°–¥–µ–ª–∞–π mixed-–º–∞—Ä–∫–µ—Ä—ã –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –ø–æ –≤—Å–µ–º –≤—Ä–µ–º–µ–Ω–∞–º." },
            { day: 2, title: "Day 2: Present Simple + Present Continuous", task: "–ü—Ä–æ–π–¥–∏ –æ–±–∞ –≤—Ä–µ–º–µ–Ω–∏ –∏ –∑–∞–∫—Ä–µ–ø–∏ –ø—Ä–∏–≤—ã—á–∫–∞ vs –ø—Ä–æ—Ü–µ—Å—Å —Å–µ–π—á–∞—Å." },
            { day: 3, title: "Day 3: Past Simple + Past Continuous", task: "–û—Ç—Ä–∞–±–æ—Ç–∞–π V2 –∏ was/were + V-ing —Å –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ–º." },
            { day: 4, title: "Day 4: Future Simple", task: "–ó–∞–∫—Ä–µ–ø–∏ will + V1, –æ–±–µ—â–∞–Ω–∏—è –∏ –ø—Ä–æ–≥–Ω–æ–∑—ã." },
            { day: 5, title: "Day 5: Present Perfect", task: "–ü–æ–≤—Ç–æ—Ä–∏ have/has + V3 –∏ –≥—Ä–∞–Ω–∏—Ü—É —Å Past Simple." },
            { day: 6, title: "Day 6: Pair Mixes", task: "–ü—Ä–æ–π–¥–∏ —Ç—Ä–∏ –º–∏–∫—Å-—Ä–∞–∑–¥–µ–ª–∞: PS vs PC, Past vs Past Continuous, PP vs Past." },
            { day: 7, title: "Day 7: Mixed All", task: "–°–¥–µ–ª–∞–π –æ–±—â–∏–π –º–∏–∫—Å –ø–æ –≤—Å–µ–º 6 –≤—Ä–µ–º–µ–Ω–∞–º –∏ –ø—Ä–æ–≤–µ—Ä—å —Å–ª–∞–±—ã–µ –º–µ—Å—Ç–∞." }
        ];
        /* --- 2. STATE MANAGEMENT (LocalStorage) --- */
        let activeTopicIndex = 0;
        let progressState = null;
        const topicCharts = {};
        let activeChallengeTimer = null;
        let activeChallengeTickTimer = null;
        let topicStatsObserver = null;
        let isTopicStatsVisible = false;
        let stickyScrollRaf = null;
        let audioCtx = null;
        let tickNoiseBuffer = null;
        const TASK_SCROLL_OFFSET_PX = 108;
        const ANSWER_COOLDOWN_MS = 2000;
        const CHALLENGE_TICK_VOLUME = 0.03;
        const DAILY_GOAL_COMPLETED = 12;
        const TOPIC_PALETTES = {
            time_markers: {
                frame: "border-sky-200 bg-sky-50/70",
                frameTitle: "text-sky-900",
                frameSubtle: "text-sky-700",
                controlBtn: "border-sky-200 text-sky-700 hover:bg-sky-100",
                startBtn: "bg-sky-600 border border-sky-700 text-white hover:bg-sky-700",
                progressBar: "bg-sky-500",
                floating: "bg-sky-50 border-sky-500 text-sky-900",
                lockCard: "bg-sky-50/95 border-sky-300 text-sky-900"
            },
            present_simple: {
                frame: "border-blue-200 bg-blue-50/70",
                frameTitle: "text-blue-900",
                frameSubtle: "text-blue-700",
                controlBtn: "border-blue-200 text-blue-700 hover:bg-blue-100",
                startBtn: "bg-blue-600 border border-blue-700 text-white hover:bg-blue-700",
                progressBar: "bg-blue-500",
                floating: "bg-blue-50 border-blue-500 text-blue-900",
                lockCard: "bg-blue-50/95 border-blue-300 text-blue-900"
            },
            present_continuous: {
                frame: "border-purple-200 bg-purple-50/70",
                frameTitle: "text-purple-900",
                frameSubtle: "text-purple-700",
                controlBtn: "border-purple-200 text-purple-700 hover:bg-purple-100",
                startBtn: "bg-purple-600 border border-purple-700 text-white hover:bg-purple-700",
                progressBar: "bg-purple-500",
                floating: "bg-purple-50 border-purple-500 text-purple-900",
                lockCard: "bg-purple-50/95 border-purple-300 text-purple-900"
            },
            past_simple: {
                frame: "border-green-200 bg-green-50/70",
                frameTitle: "text-green-900",
                frameSubtle: "text-green-700",
                controlBtn: "border-green-200 text-green-700 hover:bg-green-100",
                startBtn: "bg-green-600 border border-green-700 text-white hover:bg-green-700",
                progressBar: "bg-green-500",
                floating: "bg-green-50 border-green-500 text-green-900",
                lockCard: "bg-green-50/95 border-green-300 text-green-900"
            },
            past_continuous: {
                frame: "border-emerald-200 bg-emerald-50/70",
                frameTitle: "text-emerald-900",
                frameSubtle: "text-emerald-700",
                controlBtn: "border-emerald-200 text-emerald-700 hover:bg-emerald-100",
                startBtn: "bg-emerald-600 border border-emerald-700 text-white hover:bg-emerald-700",
                progressBar: "bg-emerald-500",
                floating: "bg-emerald-50 border-emerald-500 text-emerald-900",
                lockCard: "bg-emerald-50/95 border-emerald-300 text-emerald-900"
            },
            future_simple: {
                frame: "border-yellow-200 bg-yellow-50/70",
                frameTitle: "text-yellow-900",
                frameSubtle: "text-yellow-700",
                controlBtn: "border-yellow-200 text-yellow-700 hover:bg-yellow-100",
                startBtn: "bg-yellow-400 border border-yellow-500 text-yellow-950 hover:bg-yellow-500",
                progressBar: "bg-yellow-500",
                floating: "bg-yellow-50 border-yellow-500 text-yellow-900",
                lockCard: "bg-yellow-50/95 border-yellow-300 text-yellow-900"
            },
            present_perfect: {
                frame: "border-red-200 bg-red-50/70",
                frameTitle: "text-red-900",
                frameSubtle: "text-red-700",
                controlBtn: "border-red-200 text-red-700 hover:bg-red-100",
                startBtn: "bg-red-600 border border-red-700 text-white hover:bg-red-700",
                progressBar: "bg-red-500",
                floating: "bg-red-50 border-red-500 text-red-900",
                lockCard: "bg-red-50/95 border-red-300 text-red-900"
            },
            mix_ps_pc: {
                frame: "border-cyan-200 bg-cyan-50/70",
                frameTitle: "text-cyan-900",
                frameSubtle: "text-cyan-700",
                controlBtn: "border-cyan-200 text-cyan-700 hover:bg-cyan-100",
                startBtn: "bg-cyan-600 border border-cyan-700 text-white hover:bg-cyan-700",
                progressBar: "bg-cyan-500",
                floating: "bg-cyan-50 border-cyan-500 text-cyan-900",
                lockCard: "bg-cyan-50/95 border-cyan-300 text-cyan-900"
            },
            mix_past_simple_past_continuous: {
                frame: "border-teal-200 bg-teal-50/70",
                frameTitle: "text-teal-900",
                frameSubtle: "text-teal-700",
                controlBtn: "border-teal-200 text-teal-700 hover:bg-teal-100",
                startBtn: "bg-teal-600 border border-teal-700 text-white hover:bg-teal-700",
                progressBar: "bg-teal-500",
                floating: "bg-teal-50 border-teal-500 text-teal-900",
                lockCard: "bg-teal-50/95 border-teal-300 text-teal-900"
            },
            mix_present_perfect_past_simple: {
                frame: "border-rose-200 bg-rose-50/70",
                frameTitle: "text-rose-900",
                frameSubtle: "text-rose-700",
                controlBtn: "border-rose-200 text-rose-700 hover:bg-rose-100",
                startBtn: "bg-rose-600 border border-rose-700 text-white hover:bg-rose-700",
                progressBar: "bg-rose-500",
                floating: "bg-rose-50 border-rose-500 text-rose-900",
                lockCard: "bg-rose-50/95 border-rose-300 text-rose-900"
            },
            mixed_all: {
                frame: "border-indigo-200 bg-indigo-50/70",
                frameTitle: "text-indigo-900",
                frameSubtle: "text-indigo-700",
                controlBtn: "border-indigo-200 text-indigo-700 hover:bg-indigo-100",
                startBtn: "bg-indigo-600 border border-indigo-700 text-white hover:bg-indigo-700",
                progressBar: "bg-indigo-500",
                floating: "bg-indigo-50 border-indigo-500 text-indigo-900",
                lockCard: "bg-indigo-50/95 border-indigo-300 text-indigo-900"
            }
        };
        const TOPIC_THEME_TOKENS = {
            time_markers: { primary: "#0284c7", bgSoft: "#f0f9ff", border: "#bae6fd", text: "#0c4a6e" },
            present_simple: { primary: "#2563eb", bgSoft: "#eff6ff", border: "#bfdbfe", text: "#1e3a8a" },
            present_continuous: { primary: "#7c3aed", bgSoft: "#f5f3ff", border: "#ddd6fe", text: "#4c1d95" },
            past_simple: { primary: "#16a34a", bgSoft: "#f0fdf4", border: "#bbf7d0", text: "#14532d" },
            past_continuous: { primary: "#059669", bgSoft: "#ecfdf5", border: "#a7f3d0", text: "#064e3b" },
            future_simple: { primary: "#ca8a04", bgSoft: "#fefce8", border: "#fde68a", text: "#713f12" },
            present_perfect: { primary: "#dc2626", bgSoft: "#fef2f2", border: "#fecaca", text: "#7f1d1d" },
            mix_ps_pc: { primary: "#0891b2", bgSoft: "#ecfeff", border: "#a5f3fc", text: "#164e63" },
            mix_past_simple_past_continuous: { primary: "#0f766e", bgSoft: "#f0fdfa", border: "#99f6e4", text: "#134e4a" },
            mix_present_perfect_past_simple: { primary: "#e11d48", bgSoft: "#fff1f2", border: "#fecdd3", text: "#881337" },
            mixed_all: { primary: "#4f46e5", bgSoft: "#eef2ff", border: "#c7d2fe", text: "#312e81" }
        };
        const uiState = {
            shakeTaskKey: null,
            cooldownUntilByTaskKey: {},
            matchDraftByTaskKey: {},
            successPulseTaskKey: null,
            toastTimeouts: []
        };

        function safeParse(value, fallback) {
            try {
                return JSON.parse(value);
            } catch (_) {
                return fallback;
            }
        }

        function normalizeAnswer(value) {
            return String(value || "").trim().toLowerCase();
        }

        function hashStringToUint32(value) {
            let hash = 2166136261;
            const input = String(value || "");
            for (let i = 0; i < input.length; i++) {
                hash ^= input.charCodeAt(i);
                hash = Math.imul(hash, 16777619);
            }
            return hash >>> 0;
        }

        function mulberry32(seed) {
            let t = seed >>> 0;
            return function() {
                t += 0x6D2B79F5;
                let r = Math.imul(t ^ (t >>> 15), t | 1);
                r ^= r + Math.imul(r ^ (r >>> 7), r | 61);
                return ((r ^ (r >>> 14)) >>> 0) / 4294967296;
            };
        }

        function seededShuffle(items, seedKey) {
            const shuffled = Array.isArray(items) ? [...items] : [];
            const random = mulberry32(hashStringToUint32(seedKey));
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(random() * (i + 1));
                const tmp = shuffled[i];
                shuffled[i] = shuffled[j];
                shuffled[j] = tmp;
            }
            return shuffled;
        }

        function getTaskKey(topicId, taskId) {
            return `${topicId}:${taskId}`;
        }

        function getMatchDraft(topicId, taskId) {
            const taskKey = getTaskKey(topicId, taskId);
            if (!uiState.matchDraftByTaskKey[taskKey]) {
                uiState.matchDraftByTaskKey[taskKey] = { selectedLeft: null, pairs: {} };
            }
            return uiState.matchDraftByTaskKey[taskKey];
        }

        function clearMatchDraft(topicId, taskId) {
            const taskKey = getTaskKey(topicId, taskId);
            delete uiState.matchDraftByTaskKey[taskKey];
        }

        function getTopicPalette(topicId) {
            return TOPIC_PALETTES[topicId] || {
                frame: "border-indigo-200 bg-indigo-50/70",
                frameTitle: "text-indigo-900",
                frameSubtle: "text-indigo-700",
                controlBtn: "border-indigo-200 text-indigo-700 hover:bg-indigo-100",
                startBtn: "bg-indigo-600 border border-indigo-700 text-white hover:bg-indigo-700",
                progressBar: "bg-indigo-500",
                floating: "bg-indigo-50 border-indigo-500 text-indigo-900",
                lockCard: "bg-indigo-50/95 border-indigo-300 text-indigo-900"
            };
        }

        function getTopicTheme(topicId) {
            return TOPIC_THEME_TOKENS[topicId] || TOPIC_THEME_TOKENS.mixed_all;
        }

        function applyTopicTheme(topicId) {
            const theme = getTopicTheme(topicId);
            const root = document.documentElement;
            root.style.setProperty("--topic-primary", theme.primary);
            root.style.setProperty("--topic-bg-soft", theme.bgSoft);
            root.style.setProperty("--topic-border", theme.border);
            root.style.setProperty("--topic-text", theme.text);
        }

        function getTopicChartColors(topicId) {
            const theme = getTopicTheme(topicId);
            return {
                solid: theme.primary,
                soft: `${theme.primary}44`,
                accentText: "text-gray-800",
                accentBg: "bg-white"
            };
        }

        function scrollToElementWithOffset(el, offset = TASK_SCROLL_OFFSET_PX) {
            if (!el) return;
            const targetTop = Math.max(0, el.getBoundingClientRect().top + window.pageYOffset - offset);
            window.scrollTo({ top: targetTop, behavior: "smooth" });
        }

        function scrollToNextTask(topicId, currentTaskIndex) {
            const nextTaskEl = document.getElementById(`task-${topicId}-${currentTaskIndex + 1}`);
            if (nextTaskEl) {
                scrollToElementWithOffset(nextTaskEl, TASK_SCROLL_OFFSET_PX);
                return;
            }
            const summaryEl = document.getElementById("topicStatsContainer");
            if (summaryEl) {
                scrollToElementWithOffset(summaryEl, 96);
            }
        }

        function getTaskCooldownKey(topicId, taskId) {
            return getTaskKey(topicId, taskId);
        }

        function getTaskCooldownLeftMs(topicId, taskId) {
            const key = getTaskCooldownKey(topicId, taskId);
            const expiresAt = Number(uiState.cooldownUntilByTaskKey[key] || 0);
            if (!expiresAt) return 0;
            const left = expiresAt - Date.now();
            if (left <= 0) {
                delete uiState.cooldownUntilByTaskKey[key];
                return 0;
            }
            return left;
        }

        function startTaskCooldown(topicId, taskId, durationMs = ANSWER_COOLDOWN_MS) {
            const key = getTaskCooldownKey(topicId, taskId);
            const expiresAt = Date.now() + durationMs;
            uiState.cooldownUntilByTaskKey[key] = expiresAt;
            setTimeout(() => {
                if (uiState.cooldownUntilByTaskKey[key] !== expiresAt) return;
                delete uiState.cooldownUntilByTaskKey[key];
                const topic = topics[activeTopicIndex];
                if (topic && topic.id === topicId) {
                    renderContent();
                }
            }, durationMs + 30);
        }

        function createDefaultTaskState() {
            return {
                attempts: 0,
                solved: false,
                correct: false,
                lastAnswer: null,
                lastWasCorrect: null,
                lastUpdated: null,
                challengeWrong: false
            };
        }

        function createDefaultChallengeTopicState() {
            return {
                locked: true,
                isRunning: false,
                isCompleted: false,
                startedAt: null,
                endAt: null,
                lastResult: null,
                bestTimeSeconds: null
            };
        }

        function createDefaultChallengeState() {
            const topicState = {};
            topics.forEach(topic => {
                topicState[topic.id] = createDefaultChallengeTopicState();
            });
            return {
                soundEnabled: true,
                topicState
            };
        }

        function createDefaultProgress() {
            const topicTaskState = {};
            topics.forEach(topic => {
                topicTaskState[topic.id] = {};
                topic.tasks.forEach(task => {
                    topicTaskState[topic.id][task.id] = createDefaultTaskState();
                });
            });

            const dayState = {};
            studyPlan.forEach((_, idx) => {
                dayState[idx] = false;
            });

            const base = {
                appVersion: APP_VERSION,
                topicTaskState,
                dayState,
                challenge: createDefaultChallengeState(),
                dailyPractice: {},
                challengePBSeconds: null,
                stats: {
                    xp: 0,
                    progressPercent: 0,
                    completedTasks: 0,
                    totalTasks: topics.reduce((sum, topic) => sum + topic.tasks.length, 0),
                    correctCount: 0,
                    attemptCount: 0
                }
            };
            base.stats = computeStats(base);
            return base;
        }

        function normalizeProgress(raw) {
            const base = createDefaultProgress();
            if (!raw || typeof raw !== "object") return base;

            const normalized = {
                appVersion: APP_VERSION,
                topicTaskState: {},
                dayState: {},
                challenge: createDefaultChallengeState(),
                dailyPractice: {},
                challengePBSeconds: null,
                stats: base.stats
            };

            topics.forEach(topic => {
                normalized.topicTaskState[topic.id] = {};
                topic.tasks.forEach(task => {
                    const savedTaskState = raw.topicTaskState &&
                        raw.topicTaskState[topic.id] &&
                        raw.topicTaskState[topic.id][task.id];
                    normalized.topicTaskState[topic.id][task.id] = {
                        ...createDefaultTaskState(),
                        ...(savedTaskState || {})
                    };
                });

                const rawChallengeTopicState = raw.challenge &&
                    raw.challenge.topicState &&
                    raw.challenge.topicState[topic.id];
                normalized.challenge.topicState[topic.id] = {
                    ...createDefaultChallengeTopicState(),
                    ...(rawChallengeTopicState || {})
                };
            });

            studyPlan.forEach((_, idx) => {
                normalized.dayState[idx] = Boolean(raw.dayState && raw.dayState[idx]);
            });

            normalized.challenge.soundEnabled = raw.challenge && typeof raw.challenge.soundEnabled === "boolean"
                ? raw.challenge.soundEnabled
                : true;
            normalized.dailyPractice = raw.dailyPractice && typeof raw.dailyPractice === "object"
                ? raw.dailyPractice
                : {};
            normalized.challengePBSeconds = Number.isFinite(raw.challengePBSeconds)
                ? Number(raw.challengePBSeconds)
                : null;

            normalized.stats = computeStats(normalized);
            return normalized;
        }

        function migrateLegacyState() {
            const migrated = createDefaultProgress();
            const legacyQuiz = safeParse(localStorage.getItem(LEGACY_QUIZ_KEY) || localStorage.getItem(OLD_LEGACY_QUIZ_KEY), {});
            const legacyDays = safeParse(localStorage.getItem(LEGACY_DAY_KEY) || localStorage.getItem(OLD_LEGACY_DAY_KEY), {});
            const migratedAt = new Date().toISOString();

            topics.forEach(topic => {
                topic.tasks.forEach((task, taskIdx) => {
                    const legacyKey = `${topic.id}-${taskIdx}`;
                    if (!Object.prototype.hasOwnProperty.call(legacyQuiz, legacyKey)) return;

                    const legacyValue = legacyQuiz[legacyKey];
                    const taskState = migrated.topicTaskState[topic.id][task.id];
                    taskState.attempts = 1;
                    taskState.lastAnswer = legacyValue;
                    taskState.lastUpdated = migratedAt;

                    if (task.type === "mc" && Number(legacyValue) === task.correct) {
                        taskState.correct = true;
                        taskState.solved = true;
                        taskState.lastWasCorrect = true;
                    } else {
                        taskState.lastWasCorrect = false;
                    }
                });
            });

            studyPlan.forEach((_, idx) => {
                migrated.dayState[idx] = legacyDays && legacyDays[idx] === true;
            });

            migrated.stats = computeStats(migrated);
            return migrated;
        }

        function loadProgress() {
            const savedV2 = safeParse(localStorage.getItem(STORAGE_KEY_V2), null);
            if (savedV2) {
                progressState = normalizeProgress(savedV2);
                updateStats();
                return;
            }

            const oldSavedV2 = safeParse(localStorage.getItem(OLD_STORAGE_KEY_V2), null);
            if (oldSavedV2) {
                progressState = normalizeProgress(oldSavedV2);
                localStorage.setItem(STORAGE_KEY_V2, JSON.stringify(progressState));
                localStorage.removeItem(OLD_STORAGE_KEY_V2);
                updateStats();
                return;
            }

            const hasLegacy = localStorage.getItem(LEGACY_QUIZ_KEY) ||
                localStorage.getItem(LEGACY_DAY_KEY) ||
                localStorage.getItem(OLD_LEGACY_QUIZ_KEY) ||
                localStorage.getItem(OLD_LEGACY_DAY_KEY);
            if (hasLegacy) {
                progressState = normalizeProgress(migrateLegacyState());
                localStorage.setItem(STORAGE_KEY_V2, JSON.stringify(progressState));
            } else {
                progressState = createDefaultProgress();
                localStorage.setItem(STORAGE_KEY_V2, JSON.stringify(progressState));
            }
            updateStats();
        }

        function saveProgress() {
            progressState.stats = computeStats(progressState);
            localStorage.setItem(STORAGE_KEY_V2, JSON.stringify(progressState));
            updateStats();
        }

        function resetProgress() {
            if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –≤–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å—Å?")) {
                console.log("[reset] Full progress reset started");
                stopChallengeTimer();
                localStorage.removeItem(STORAGE_KEY_V2);
                localStorage.removeItem(LEGACY_QUIZ_KEY);
                localStorage.removeItem(LEGACY_DAY_KEY);
                localStorage.removeItem(OLD_STORAGE_KEY_V2);
                localStorage.removeItem(OLD_LEGACY_QUIZ_KEY);
                localStorage.removeItem(OLD_LEGACY_DAY_KEY);
                Object.keys(topicCharts).forEach(chartId => {
                    if (topicCharts[chartId]) topicCharts[chartId].destroy();
                    delete topicCharts[chartId];
                });
                uiState.shakeTaskKey = null;
                uiState.cooldownUntilByTaskKey = {};
                uiState.matchDraftByTaskKey = {};
                activeTopicIndex = 0;
                progressState = createDefaultProgress();
                saveProgress();
                renderTabs();
                renderContent();
                renderTimeline();
                updateStats();
                console.log("[reset] Full progress reset completed");
            }
        }

        window.resetProgress = resetProgress;

        /* --- 3. STATS + EXPORT --- */
        function getTaskState(topicId, taskId) {
            return progressState.topicTaskState[topicId][taskId];
        }

        function getTopicSolvedCount(topicId) {
            const topic = topics.find(t => t.id === topicId);
            if (!topic) return 0;
            return topic.tasks.filter(task => getTaskState(topicId, task.id).solved).length;
        }

        function areAllTopicTasksAttempted(topicId) {
            const topic = topics.find(t => t.id === topicId);
            if (!topic) return false;
            return topic.tasks.every(task => Number(getTaskState(topicId, task.id).attempts || 0) > 0);
        }

        function getChallengeState(topicId) {
            if (!progressState.challenge) {
                progressState.challenge = createDefaultChallengeState();
            }
            if (!progressState.challenge.topicState[topicId]) {
                progressState.challenge.topicState[topicId] = createDefaultChallengeTopicState();
            }
            return progressState.challenge.topicState[topicId];
        }

        function formatTime(totalSeconds) {
            const safe = Math.max(0, Number(totalSeconds || 0));
            const mm = String(Math.floor(safe / 60)).padStart(2, '0');
            const ss = String(safe % 60).padStart(2, '0');
            return `${mm}:${ss}`;
        }

        function getLocalDateKey(date = new Date()) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, "0");
            const d = String(date.getDate()).padStart(2, "0");
            return `${y}-${m}-${d}`;
        }

        function shiftDateKey(dateKey, offsetDays) {
            const [y, m, d] = String(dateKey).split("-").map(Number);
            const date = new Date(y, (m || 1) - 1, d || 1);
            date.setDate(date.getDate() + offsetDays);
            return getLocalDateKey(date);
        }

        function ensureDailyPracticeDay(dateKey) {
            if (!progressState.dailyPractice || typeof progressState.dailyPractice !== "object") {
                progressState.dailyPractice = {};
            }
            if (!progressState.dailyPractice[dateKey]) {
                progressState.dailyPractice[dateKey] = {
                    attempts: 0,
                    completed: 0,
                    wrongAttempts: 0
                };
            }
            return progressState.dailyPractice[dateKey];
        }

        function recordDailyPracticeAttempt({ isCorrect }) {
            const todayKey = getLocalDateKey();
            const dayState = ensureDailyPracticeDay(todayKey);
            dayState.attempts += 1;
            dayState.completed += 1;
            if (!isCorrect) dayState.wrongAttempts += 1;
        }

        function getCurrentStreakDays() {
            if (!progressState || !progressState.dailyPractice) return 0;
            let streak = 0;
            let cursor = getLocalDateKey();
            while (true) {
                const day = progressState.dailyPractice[cursor];
                if (!day || Number(day.attempts || 0) <= 0) break;
                streak += 1;
                cursor = shiftDateKey(cursor, -1);
            }
            return streak;
        }

        function getTodaysPracticeSummary() {
            const todayKey = getLocalDateKey();
            const day = (progressState && progressState.dailyPractice && progressState.dailyPractice[todayKey]) || {};
            const completed = Number(day.completed || 0);
            const wrongAttempts = Number(day.wrongAttempts || 0);
            return {
                completed,
                wrongAttempts,
                goal: DAILY_GOAL_COMPLETED,
                goalPercent: Math.min(100, Math.round((completed / DAILY_GOAL_COMPLETED) * 100))
            };
        }

        function truncateText(value, max = 50) {
            const clean = String(value || "").replace(/\s+/g, " ").trim();
            if (clean.length <= max) return clean;
            return `${clean.slice(0, Math.max(0, max - 1))}‚Ä¶`;
        }

        function getMostMissedTasks(limit = 3) {
            const ranked = [];
            topics.forEach(topic => {
                topic.tasks.forEach((task, taskIndex) => {
                    const state = getTaskState(topic.id, task.id);
                    const attempts = Number(state.attempts || 0);
                    const correctCount = state.correct ? 1 : 0;
                    const wrongCount = Math.max(0, attempts - correctCount);
                    if (wrongCount <= 0) return;
                    ranked.push({
                        topicId: topic.id,
                        topicTitle: topic.title,
                        taskId: task.id,
                        taskIndex,
                        prompt: task.prompt,
                        wrongCount,
                        attempts,
                        solved: Boolean(state.solved)
                    });
                });
            });
            ranked.sort((a, b) => (b.wrongCount - a.wrongCount) || (b.attempts - a.attempts));
            return ranked.slice(0, limit);
        }

        function getRemainingSeconds(topicId) {
            const challenge = getChallengeState(topicId);
            if (!challenge.isRunning || !challenge.endAt) return 0;
            const diffMs = new Date(challenge.endAt).getTime() - Date.now();
            return Math.max(0, Math.ceil(diffMs / 1000));
        }

        function syncChallengeState(topicId) {
            const challenge = getChallengeState(topicId);
            if (!challenge.isRunning || !challenge.endAt) return;
            if (areAllTopicTasksAttempted(topicId)) {
                const topic = topics.find(t => t.id === topicId);
                if (!topic) return;
                const status = getTopicSolvedCount(topicId) === topic.tasks.length ? "success" : "attempted";
                completeChallenge(topicId, status);
                return;
            }
            if (new Date(challenge.endAt).getTime() <= Date.now()) {
                completeChallenge(topicId, "timeout");
            }
        }

        function renderChallengeHud() {
            const topic = topics[activeTopicIndex];
            if (!topic || !progressState) return;
            const challenge = getChallengeState(topic.id);
            const theme = getTopicTheme(topic.id);
            const total = topic.tasks.length;
            const solved = getTopicSolvedCount(topic.id);
            let remaining = CHALLENGE_TOTAL_SECONDS;
            if (challenge.isRunning) {
                remaining = getRemainingSeconds(topic.id);
            } else if (challenge.lastResult) {
                remaining = Number.isFinite(challenge.lastResult.timeLeftSeconds)
                    ? challenge.lastResult.timeLeftSeconds
                    : Math.max(0, CHALLENGE_TOTAL_SECONDS - Number(challenge.lastResult.timeSpentSeconds || 0));
            }
            const progressPercent = total ? Math.round((solved / total) * 100) : 0;

            const timerEl = document.getElementById("challengeTimeLeft");
            const solvedEl = document.getElementById("challengeSolvedCount");
            const progressEl = document.getElementById("challengeProgressBar");
            const statusEl = document.getElementById("challengeStatusText");
            const floatingTimerEl = document.getElementById("floatingChallengeTimeLeft");
            const floatingSolvedEl = document.getElementById("floatingChallengeSolvedCount");
            const floatingStatusEl = document.getElementById("floatingChallengeStatusText");
            const stickyTimerPillEl = document.getElementById("stickyTimerPill");
            const stickyTimerEl = document.getElementById("stickyChallengeTimeLeft");
            const stickyTitleEl = document.getElementById("stickyActiveTopicTitle");
            const stickyProgressEl = document.getElementById("stickyActiveTopicProgress");
            const stickySoundEl = document.getElementById("stickySoundBtn");
            const stickyResetEl = document.getElementById("stickyResetBtn");
            const stickyBar = document.getElementById("stickyTopicBar");

            if (timerEl) timerEl.textContent = formatTime(remaining);
            if (solvedEl) solvedEl.textContent = `${solved}/${total}`;
            if (progressEl) progressEl.style.width = `${progressPercent}%`;
            if (floatingTimerEl) floatingTimerEl.textContent = formatTime(remaining);
            if (floatingSolvedEl) floatingSolvedEl.textContent = `${solved}/${total}`;
            if (stickyTimerEl) stickyTimerEl.textContent = formatTime(remaining);
            if (stickyTimerPillEl) stickyTimerPillEl.classList.toggle("hidden", !challenge.isRunning);
            if (stickyTitleEl) stickyTitleEl.textContent = topic.title;
            if (stickyProgressEl) stickyProgressEl.textContent = `${solved}/${total} completed`;
            if (stickySoundEl) stickySoundEl.textContent = progressState.challenge.soundEnabled ? "üîä Sound" : "üîá Mute";
            if (stickyResetEl) stickyResetEl.textContent = (challenge.lastResult && !challenge.isRunning) ? "Try again" : "Reset";

            if (stickyBar) {
                stickyBar.style.borderColor = theme.border;
                stickyBar.style.background = theme.bgSoft;
            }
            if (stickySoundEl) {
                stickySoundEl.style.borderColor = theme.border;
                stickySoundEl.style.color = theme.text;
            }
            if (stickyResetEl) {
                stickyResetEl.style.borderColor = theme.border;
                stickyResetEl.style.color = theme.text;
            }
            if (stickyTimerPillEl) {
                stickyTimerPillEl.style.borderColor = theme.border;
                stickyTimerPillEl.style.color = theme.text;
            }

            if (statusEl) {
                if (challenge.isRunning) {
                    statusEl.textContent = "Challenge is running";
                } else if (challenge.lastResult && challenge.lastResult.status === "success") {
                    statusEl.textContent = `Success in ${formatTime(challenge.lastResult.timeSpentSeconds)}`;
                } else if (challenge.lastResult && challenge.lastResult.status === "attempted") {
                    statusEl.textContent = `All tasks attempted in ${formatTime(challenge.lastResult.timeSpentSeconds)}`;
                } else if (challenge.lastResult && challenge.lastResult.status === "timeout") {
                    statusEl.textContent = "Time is up";
                } else {
                    statusEl.textContent = "Locked";
                }
            }

            if (floatingStatusEl) {
                if (challenge.isRunning) {
                    floatingStatusEl.textContent = "Challenge is running";
                } else if (challenge.lastResult && challenge.lastResult.status === "success") {
                    floatingStatusEl.textContent = `Success in ${formatTime(challenge.lastResult.timeSpentSeconds)}`;
                } else if (challenge.lastResult && challenge.lastResult.status === "attempted") {
                    floatingStatusEl.textContent = `All tasks attempted in ${formatTime(challenge.lastResult.timeSpentSeconds)}`;
                } else if (challenge.lastResult && challenge.lastResult.status === "timeout") {
                    floatingStatusEl.textContent = "Time is up";
                } else {
                    floatingStatusEl.textContent = "Locked";
                }
            }
        }

        function showToast(message, type = "info") {
            const container = document.getElementById("toastContainer");
            if (!container) return;
            const icon = type === "success"
                ? "fa-circle-check"
                : (type === "error" ? "fa-circle-exclamation" : "fa-circle-info");
            const toast = document.createElement("div");
            toast.className = "toast-item";
            toast.innerHTML = `<div class="flex items-start gap-2"><i class="fas ${icon} mt-0.5"></i><p class="text-sm font-semibold">${message}</p></div>`;
            container.appendChild(toast);
            const timeoutId = setTimeout(() => {
                toast.remove();
            }, 2200);
            uiState.toastTimeouts.push(timeoutId);
        }

        function setupStickyBarScrollFx() {
            const stickyBar = document.getElementById("stickyTopicBar");
            if (!stickyBar) return;
            window.addEventListener("scroll", () => {
                if (stickyScrollRaf) return;
                stickyScrollRaf = requestAnimationFrame(() => {
                    stickyBar.classList.toggle("sticky-topic-bar-scrolled", window.scrollY > 40);
                    stickyScrollRaf = null;
                });
            }, { passive: true });
        }

        function startChallengeTimer(topicId) {
            if (activeChallengeTimer) {
                clearInterval(activeChallengeTimer);
                activeChallengeTimer = null;
            }
            startTickingClock(topicId);
            activeChallengeTimer = setInterval(() => {
                const topic = topics[activeTopicIndex];
                if (!topic || topic.id !== topicId) return;
                const challenge = getChallengeState(topic.id);
                if (!challenge.isRunning) return;
                const remaining = getRemainingSeconds(topic.id);
                if (remaining <= 0) {
                    completeChallenge(topic.id, "timeout");
                    return;
                }
                renderChallengeHud();
            }, 250);
        }

        function stopChallengeTimer() {
            if (activeChallengeTimer) {
                clearInterval(activeChallengeTimer);
                activeChallengeTimer = null;
            }
            stopTickingClock();
        }

        function startTickingClock(topicId) {
            stopTickingClock();
            activeChallengeTickTimer = setInterval(() => {
                const topic = topics[activeTopicIndex];
                if (!topic || topic.id !== topicId) return;
                const challenge = getChallengeState(topic.id);
                if (!challenge.isRunning) {
                    stopTickingClock();
                    return;
                }
                const currentSecond = getRemainingSeconds(topic.id);
                if (currentSecond <= 0) {
                    stopTickingClock();
                    return;
                }
                playTickSound();
            }, 1000);
        }

        function stopTickingClock() {
            if (activeChallengeTickTimer) {
                clearInterval(activeChallengeTickTimer);
                activeChallengeTickTimer = null;
            }
        }

        function initAudioIfNeeded() {
            if (audioCtx) {
                audioCtx.resume();
                return;
            }
            const AudioContextClass = window.AudioContext || window.webkitAudioContext;
            if (!AudioContextClass) return;
            audioCtx = new AudioContextClass();
        }

        function getTickNoiseBuffer() {
            if (!audioCtx) return null;
            if (tickNoiseBuffer) return tickNoiseBuffer;
            const durationSec = 0.06;
            const frameCount = Math.floor(audioCtx.sampleRate * durationSec);
            const buffer = audioCtx.createBuffer(1, frameCount, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < frameCount; i++) {
                data[i] = (Math.random() * 2 - 1) * 0.7;
            }
            tickNoiseBuffer = buffer;
            return tickNoiseBuffer;
        }

        function playTickSound() {
            if (!progressState.challenge || !progressState.challenge.soundEnabled || !audioCtx || audioCtx.state !== "running") return;
            const noiseBuffer = getTickNoiseBuffer();
            if (!noiseBuffer) return;

            const now = audioCtx.currentTime;
            const source = audioCtx.createBufferSource();
            const bandpass = audioCtx.createBiquadFilter();
            const lowpass = audioCtx.createBiquadFilter();
            const gain = audioCtx.createGain();

            source.buffer = noiseBuffer;
            bandpass.type = "bandpass";
            bandpass.frequency.setValueAtTime(1700, now);
            bandpass.Q.setValueAtTime(0.8, now);
            lowpass.type = "lowpass";
            lowpass.frequency.setValueAtTime(2600, now);
            lowpass.Q.setValueAtTime(0.7, now);

            gain.gain.setValueAtTime(0.0001, now);
            gain.gain.exponentialRampToValueAtTime(CHALLENGE_TICK_VOLUME, now + 0.004);
            gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.04);

            source.connect(bandpass);
            bandpass.connect(lowpass);
            lowpass.connect(gain);
            gain.connect(audioCtx.destination);

            source.start(now);
            source.stop(now + 0.05);
        }

        function playBeep({ frequency, duration, type = "sine", volume = 0.04, delay = 0 }) {
            if (!progressState.challenge || !progressState.challenge.soundEnabled || !audioCtx) return;
            const now = audioCtx.currentTime + delay;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(frequency, now);
            gain.gain.setValueAtTime(volume, now);
            gain.gain.exponentialRampToValueAtTime(0.0001, now + duration);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start(now);
            osc.stop(now + duration);
        }

        function playSuccessSound() {
            playBeep({ frequency: 740, duration: 0.08, type: "triangle", volume: 0.06 });
            playBeep({ frequency: 988, duration: 0.12, type: "triangle", volume: 0.05, delay: 0.09 });
        }

        function playErrorSound() {
            playBeep({ frequency: 220, duration: 0.08, type: "sawtooth", volume: 0.06 });
            playBeep({ frequency: 170, duration: 0.12, type: "sawtooth", volume: 0.05, delay: 0.08 });
        }

        function completeChallenge(topicId, status) {
            const topic = topics.find(t => t.id === topicId);
            if (!topic) return;
            const challenge = getChallengeState(topicId);
            if (challenge.isCompleted && !challenge.isRunning) return;

            const total = topic.tasks.length;
            const solved = getTopicSolvedCount(topicId);
            const endTime = Date.now();
            const startTime = challenge.startedAt ? new Date(challenge.startedAt).getTime() : endTime;
            const elapsedSeconds = Math.max(0, Math.min(CHALLENGE_TOTAL_SECONDS, Math.ceil((endTime - startTime) / 1000)));
            const timeLeftSeconds = Math.max(0, CHALLENGE_TOTAL_SECONDS - elapsedSeconds);

            challenge.isRunning = false;
            challenge.isCompleted = true;
            challenge.locked = true;
            challenge.endAt = null;
            challenge.lastResult = {
                status,
                solved,
                total,
                timeSpentSeconds: elapsedSeconds,
                timeLeftSeconds,
                finishedAt: new Date().toISOString()
            };

            if (status === "success") {
                if (challenge.bestTimeSeconds === null || elapsedSeconds < challenge.bestTimeSeconds) {
                    challenge.bestTimeSeconds = elapsedSeconds;
                }
                confetti({
                    particleCount: 140,
                    spread: 90,
                    origin: { y: 0.6 },
                    colors: ['#a855f7', '#3b82f6', '#22c55e']
                });
            }
            if ((status === "success" || status === "attempted") && elapsedSeconds > 0) {
                if (progressState.challengePBSeconds === null || elapsedSeconds < progressState.challengePBSeconds) {
                    progressState.challengePBSeconds = elapsedSeconds;
                }
            }
            if (status === "success") {
                showToast(`Topic finished: ${topic.title}`, "success");
            } else if (status === "attempted") {
                showToast(`All tasks attempted: ${topic.title}`, "info");
            } else if (status === "timeout") {
                showToast(`Time is up: ${topic.title}`, "error");
            }

            saveProgress();
            if (topics[activeTopicIndex] && topics[activeTopicIndex].id === topicId) {
                stopChallengeTimer();
                renderContent();
            }
        }

        function computeStats(state) {
            let completedTasks = 0;
            let correctCount = 0;
            let attemptCount = 0;
            const totalTasks = topics.reduce((sum, topic) => sum + topic.tasks.length, 0);

            topics.forEach(topic => {
                topic.tasks.forEach(task => {
                    const taskState = state.topicTaskState[topic.id][task.id];
                    attemptCount += Number(taskState.attempts || 0);
                    if (taskState.correct) correctCount++;
                    if (taskState.solved) completedTasks++;
                });
            });

            const completedDays = studyPlan.filter((_, idx) => state.dayState[idx]).length;
            const xp = (correctCount * 10) + (completedDays * 50);
            const progressPercent = totalTasks ? Math.round((completedTasks / totalTasks) * 100) : 0;

            return {
                xp,
                progressPercent,
                completedTasks,
                totalTasks,
                correctCount,
                attemptCount
            };
        }

        function updateStats() {
            const stats = computeStats(progressState);
            progressState.stats = stats;

            const completedDays = studyPlan.filter((_, idx) => progressState.dayState[idx]).length;
            const xpEl = document.getElementById('xpDisplay');
            const progressEl = document.getElementById('totalProgressDisplay');
            const daysEl = document.getElementById('daysCompleted');
            const completedTasksEl = document.getElementById('completedTasksDisplay');
            const totalTasksEl = document.getElementById('totalTasksDisplay');
            const correctCountEl = document.getElementById('correctCountDisplay');
            const attemptCountEl = document.getElementById('attemptCountDisplay');

            if (xpEl) xpEl.innerText = `${stats.xp} XP`;
            if (progressEl) progressEl.innerText = `${stats.progressPercent}%`;
            if (daysEl) daysEl.innerText = completedDays;
            if (completedTasksEl) completedTasksEl.innerText = stats.completedTasks;
            if (totalTasksEl) totalTasksEl.innerText = stats.totalTasks;
            if (correctCountEl) correctCountEl.innerText = stats.correctCount;
            if (attemptCountEl) attemptCountEl.innerText = stats.attemptCount;
            renderDashboardCards();
            renderTopicStats();
        }

        function computeTopicStats(topic, state) {
            const total = topic.tasks.length;
            let completed = 0;
            let attempts = 0;
            let correct = 0;

            topic.tasks.forEach(task => {
                const taskState = state.topicTaskState[topic.id][task.id];
                attempts += Number(taskState.attempts || 0);
                if (taskState.solved) completed++;
                if (taskState.correct) correct++;
            });

            const completionPercent = total ? Math.round((completed / total) * 100) : 0;
            const accuracyPercent = attempts ? Math.round((correct / attempts) * 100) : 0;

            return { total, completed, attempts, correct, completionPercent, accuracyPercent };
        }

        function buildReportHtml(exportedAtIso) {
            const exportedAt = new Date(exportedAtIso);
            const stats = computeStats(progressState);
            const topicRows = topics.map(topic => {
                const t = computeTopicStats(topic, progressState);
                return `
                    <tr>
                        <td>${topic.title}</td>
                        <td>${t.completed} / ${t.total}</td>
                        <td>${t.correct} / ${t.attempts}</td>
                        <td>${t.attempts}</td>
                        <td>${t.completionPercent}%</td>
                        <td>${t.accuracyPercent}%</td>
                    </tr>
                `;
            }).join('');

            const chartBlocks = topics.map(topic => {
                const t = computeTopicStats(topic, progressState);
                return `
                    <div class="chart-card">
                        <h3>${topic.title}</h3>
                        <div class="metric">Completion ${t.completed}/${t.total} (${t.completionPercent}%)</div>
                        <div class="bar-track"><div class="bar-fill bar-completion" style="width:${t.completionPercent}%"></div></div>
                        <div class="metric">Accuracy ${t.correct}/${t.attempts} (${t.accuracyPercent}%)</div>
                        <div class="bar-track"><div class="bar-fill bar-accuracy" style="width:${t.accuracyPercent}%"></div></div>
                    </div>
                `;
            }).join('');

            return `<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Kirill Report</title>
    <style>
        body { font-family: Arial, sans-serif; color: #1f2937; margin: 24px; }
        h1 { margin-bottom: 4px; }
        .muted { color: #6b7280; font-size: 13px; margin-bottom: 16px; }
        .stats-grid { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 10px; margin-bottom: 18px; }
        .card { border: 1px solid #e5e7eb; border-radius: 10px; padding: 10px 12px; background: #f9fafb; }
        .card strong { display: block; font-size: 20px; margin-top: 4px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 18px; font-size: 13px; }
        th, td { border: 1px solid #e5e7eb; padding: 8px; text-align: left; }
        th { background: #f3f4f6; }
        .charts { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .chart-card { border: 1px solid #e5e7eb; border-radius: 10px; padding: 10px; background: #fff; }
        .chart-card h3 { margin: 0 0 8px 0; font-size: 15px; }
        .metric { font-size: 12px; margin-bottom: 4px; color: #374151; }
        .bar-track { width: 100%; height: 10px; background: #e5e7eb; border-radius: 999px; overflow: hidden; margin-bottom: 8px; }
        .bar-fill { height: 100%; border-radius: 999px; }
        .bar-completion { background: #4f46e5; }
        .bar-accuracy { background: #16a34a; }
    </style>
</head>
<body>
    <h1>–£—á–µ–±–Ω—ã–π –æ—Ç—á–µ—Ç –ö–∏—Ä–∏–ª–ª–∞</h1>
    <div class="muted">–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ: ${exportedAt.toLocaleString('ru-RU')}</div>
    <div class="stats-grid">
        <div class="card">–í—ã–ø–æ–ª–Ω–µ–Ω–æ –∑–∞–¥–∞—á<strong>${stats.completedTasks} / ${stats.totalTasks}</strong></div>
        <div class="card">–ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã<strong>${stats.correctCount}</strong></div>
        <div class="card">–í—Å–µ–≥–æ –ø–æ–ø—ã—Ç–æ–∫<strong>${stats.attemptCount}</strong></div>
    </div>
    <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–µ–º–∞–º</h2>
    <table>
        <thead>
            <tr>
                <th>–¢–µ–º–∞</th>
                <th>Completion</th>
                <th>Accuracy</th>
                <th>Attempts</th>
                <th>Completion %</th>
                <th>Accuracy %</th>
            </tr>
        </thead>
        <tbody>${topicRows}</tbody>
    </table>
    <h2>Charts</h2>
    <div class="charts">${chartBlocks}</div>
</body>
<\/html>`;
        }

        function destroyTopicCharts() {
            Object.keys(topicCharts).forEach((key) => {
                if (topicCharts[key]) topicCharts[key].destroy();
                delete topicCharts[key];
            });
        }

        function setupTopicStatsObserver() {
            const section = document.getElementById("topicStatsSection");
            if (!section) return;
            if (!("IntersectionObserver" in window)) {
                isTopicStatsVisible = true;
                renderTopicStats();
                return;
            }
            if (topicStatsObserver) {
                topicStatsObserver.disconnect();
                topicStatsObserver = null;
            }
            topicStatsObserver = new IntersectionObserver((entries) => {
                const visible = entries.some(entry => entry.isIntersecting);
                isTopicStatsVisible = visible;
                if (visible) renderTopicStats();
            }, { root: null, rootMargin: "140px 0px", threshold: 0.05 });
            topicStatsObserver.observe(section);
        }

        function renderTopicStats() {
            const container = document.getElementById('topicStatsContainer');
            if (!container || !progressState) return;
            destroyTopicCharts();

            container.innerHTML = topics.map((topic, index) => {
                const t = computeTopicStats(topic, progressState);
                const chartColors = getTopicChartColors(topic.id);
                const theme = getTopicTheme(topic.id);
                return `
                    <div class="premium-enter rounded-2xl shadow-md p-5 border bg-white" style="border-color:${theme.border}">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-bold text-gray-800">${topic.title}</h3>
                            <span class="text-xs px-2 py-1 rounded ${chartColors.accentBg} ${chartColors.accentText}" style="border:1px solid ${theme.border}; color:${theme.text}">${t.completed}/${t.total}</span>
                        </div>
                        <div class="grid grid-cols-3 gap-3 mb-4">
                            <div class="${chartColors.accentBg} rounded-lg p-2" style="border:1px solid ${theme.border}">
                                <p class="text-[10px] uppercase text-gray-400 font-bold">Completion</p>
                                <p class="text-sm font-bold ${chartColors.accentText}" style="color:${theme.text}">${t.completed}/${t.total}</p>
                            </div>
                            <div class="${chartColors.accentBg} rounded-lg p-2" style="border:1px solid ${theme.border}">
                                <p class="text-[10px] uppercase text-gray-400 font-bold">Accuracy</p>
                                <p class="text-sm font-bold ${chartColors.accentText}" style="color:${theme.text}">${t.correct}/${t.attempts}</p>
                            </div>
                            <div class="${chartColors.accentBg} rounded-lg p-2" style="border:1px solid ${theme.border}">
                                <p class="text-[10px] uppercase text-gray-400 font-bold">Attempts</p>
                                <p class="text-sm font-bold ${chartColors.accentText}" style="color:${theme.text}">${t.attempts}</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="h-44"><canvas id="topicCompletionChart-${index}"></canvas></div>
                            <div class="h-44"><canvas id="topicAccuracyChart-${index}"></canvas></div>
                        </div>
                    </div>
                `;
            }).join('');

            if (!isTopicStatsVisible || !window.Chart) return;

            topics.forEach((topic, index) => {
                const t = computeTopicStats(topic, progressState);
                const chartColors = getTopicChartColors(topic.id);
                const completionCanvasId = `topicCompletionChart-${index}`;
                const accuracyCanvasId = `topicAccuracyChart-${index}`;

                if (topicCharts[completionCanvasId]) topicCharts[completionCanvasId].destroy();
                if (topicCharts[accuracyCanvasId]) topicCharts[accuracyCanvasId].destroy();

                const completionCanvas = document.getElementById(completionCanvasId);
                const accuracyCanvas = document.getElementById(accuracyCanvasId);
                if (!completionCanvas || !accuracyCanvas) return;

                topicCharts[completionCanvasId] = new Chart(completionCanvas, {
                    type: 'doughnut',
                    data: {
                        labels: ['Completed', 'Remaining'],
                        datasets: [{
                            data: [t.completed, Math.max(0, t.total - t.completed)],
                            backgroundColor: [chartColors.soft, '#e5e7eb'],
                            borderColor: [chartColors.solid, '#e5e7eb'],
                            borderWidth: 1.5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { color: '#4b5563' }
                            },
                            title: { display: true, text: 'Completion', color: chartColors.solid }
                        }
                    }
                });

                topicCharts[accuracyCanvasId] = new Chart(accuracyCanvas, {
                    type: 'bar',
                    data: {
                        labels: ['Correct', 'Attempts'],
                        datasets: [{
                            data: [t.correct, t.attempts],
                            backgroundColor: [chartColors.solid, chartColors.soft],
                            borderColor: [chartColors.solid, chartColors.solid],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            title: { display: true, text: 'Accuracy / Attempts', color: chartColors.solid }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { precision: 0, color: '#6b7280' },
                                grid: { color: '#e5e7eb' }
                            },
                            x: {
                                ticks: { color: '#6b7280' },
                                grid: { display: false }
                            }
                        }
                    }
                });
            });
        }

        function renderDashboardCards() {
            if (!progressState) return;
            const streakEl = document.getElementById("streakBadge");
            const goalTextEl = document.getElementById("todayGoalText");
            const goalBarEl = document.getElementById("todayGoalBar");
            const pbEl = document.getElementById("challengePbText");
            const wrongTodayEl = document.getElementById("wrongTodayBadge");
            const mistakeTopListEl = document.getElementById("mistakeTopList");
            const mistakeSectionListEl = document.getElementById("mistakeBankSectionList");

            const streak = getCurrentStreakDays();
            const today = getTodaysPracticeSummary();
            const topMistakes = getMostMissedTasks(3);
            const pbSeconds = Number.isFinite(progressState.challengePBSeconds)
                ? progressState.challengePBSeconds
                : null;

            if (streakEl) streakEl.textContent = `${streak} day${streak === 1 ? "" : "s"}`;
            if (goalTextEl) goalTextEl.textContent = `${today.completed}/${today.goal}`;
            if (goalBarEl) goalBarEl.style.width = `${today.goalPercent}%`;
            if (pbEl) pbEl.textContent = pbSeconds === null ? "Best time (PB): ‚Äî" : `Best time (PB): ${formatTime(pbSeconds)}`;
            if (wrongTodayEl) wrongTodayEl.textContent = `${today.wrongAttempts} today`;

            const topMistakesHtml = topMistakes.length
                ? topMistakes.map((item) => `
                    <div class="flex items-start justify-between gap-2">
                        <div>
                            <p class="font-semibold text-gray-700">${truncateText(item.prompt, 50)}</p>
                            <p class="text-[11px] text-gray-400">${item.topicTitle}</p>
                        </div>
                        <span class="text-[11px] px-2 py-0.5 rounded-full bg-rose-50 text-rose-600 font-bold">-${item.wrongCount}</span>
                    </div>
                `).join("")
                : `<p class="text-gray-400">No mistakes yet.</p>`;

            if (mistakeTopListEl) mistakeTopListEl.innerHTML = topMistakesHtml;
            if (mistakeSectionListEl) {
                mistakeSectionListEl.innerHTML = topMistakes.length
                    ? topMistakes.map((item, idx) => `
                        <button onclick="jumpToMistakeTask('${item.topicId}', '${item.taskId}')" class="focus-ring w-full text-left px-3 py-2 rounded-lg border border-gray-200 hover:border-indigo-300 hover:bg-indigo-50 transition-colors">
                            <span class="text-xs text-gray-400 mr-2">#${idx + 1}</span>
                            <span class="font-semibold">${truncateText(item.prompt, 64)}</span>
                            <span class="text-xs text-gray-500"> (${item.topicTitle})</span>
                        </button>
                    `).join("")
                    : `<p class="text-gray-400 text-xs">No problematic tasks yet.</p>`;
            }
        }

        function getFirstProblemTaskInTopic(topicId) {
            const topic = topics.find(t => t.id === topicId);
            if (!topic) return null;
            for (let i = 0; i < topic.tasks.length; i++) {
                const task = topic.tasks[i];
                const state = getTaskState(topic.id, task.id);
                const attempts = Number(state.attempts || 0);
                const wrongCount = Math.max(0, attempts - (state.correct ? 1 : 0));
                if (wrongCount > 0) {
                    return { topicId: topic.id, taskId: task.id, taskIndex: i };
                }
            }
            return null;
        }

        window.jumpToMistakeTask = (topicId, taskId) => {
            const topicIndex = topics.findIndex(t => t.id === topicId);
            if (topicIndex < 0) return;
            const taskIndex = topics[topicIndex].tasks.findIndex(t => t.id === taskId);
            if (taskIndex < 0) return;
            activeTopicIndex = topicIndex;
            renderTabs();
            renderContent();
            const scrollToTask = () => {
                const taskEl = document.getElementById(`task-${topicId}-${taskIndex}`);
                if (taskEl) {
                    scrollToElementWithOffset(taskEl, TASK_SCROLL_OFFSET_PX);
                }
            };
            setTimeout(scrollToTask, 80);
        };

        window.reviewMistakes = () => {
            const topic = topics[activeTopicIndex];
            const firstProblem = getFirstProblemTaskInTopic(topic.id);
            if (firstProblem) {
                const taskEl = document.getElementById(`task-${topic.id}-${firstProblem.taskIndex}`);
                if (taskEl) {
                    scrollToElementWithOffset(taskEl, TASK_SCROLL_OFFSET_PX);
                    return;
                }
            }
            const section = document.getElementById("mistakeBankSection");
            if (section) {
                section.scrollIntoView({ behavior: "smooth", block: "start" });
            }
        };

        function downloadTextFile(filename, content, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        window.exportResults = () => {
            const now = new Date();
            const datePart = now.toISOString().slice(0, 10);
            const stats = computeStats(progressState);
            const payload = {
                exportedAt: now.toISOString(),
                appVersion: APP_VERSION,
                stats,
                topics: topics.map(topic => ({
                    topicId: topic.id,
                    title: topic.title,
                    tasks: topic.tasks.map(task => ({
                        taskId: task.id,
                        type: task.type,
                        prompt: task.prompt,
                        state: getTaskState(topic.id, task.id)
                    }))
                })),
                dayPlan: studyPlan.map((day, idx) => ({
                    day: day.day,
                    title: day.title,
                    task: day.task,
                    completed: Boolean(progressState.dayState[idx])
                }))
            };

            downloadTextFile(
                `kirill-progress-${datePart}.json`,
                JSON.stringify(payload, null, 2),
                'application/json'
            );
        };

        window.exportPdfReport = () => {
            const reportHtml = buildReportHtml(new Date().toISOString());
            const printWindow = window.open('', '_blank');
            if (!printWindow) return;
            printWindow.document.open();
            printWindow.document.write(reportHtml);
            printWindow.document.close();
            printWindow.onload = () => printWindow.print();
        };

        window.exportWordReport = () => {
            const now = new Date();
            const datePart = now.toISOString().slice(0, 10);
            const reportHtml = buildReportHtml(now.toISOString());
            downloadTextFile(
                `kirill-progress-report-${datePart}.doc`,
                reportHtml,
                'application/msword'
            );
        };

        /* --- 4. RENDERING FUNCTIONS --- */
        function renderTabs() {
            const container = document.getElementById('topicTabs');
            container.innerHTML = topics.map((topic, index) => {
                const topicTaskCount = topic.tasks.length;
                const completedCount = getTopicSolvedCount(topic.id);
                const isComplete = completedCount === topicTaskCount;

                return `
                <button onclick="setActiveTopic(${index})" 
                    class="w-full text-left px-5 py-4 flex items-center justify-between hover:bg-white transition-all group ${index === activeTopicIndex ? 'tab-active' : 'text-gray-500'}">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg flex items-center justify-center transition-colors ${index === activeTopicIndex ? 'bg-purple-100 text-purple-600 shadow-sm' : 'bg-gray-200 text-gray-400 group-hover:bg-gray-300'}">
                            <i class="fas ${topic.icon} text-sm"></i>
                        </div>
                        <div>
                            <span class="font-bold text-sm block">${topic.title}</span>
                            <span class="text-xs opacity-60">${completedCount}/${topicTaskCount} –ø—Ä–æ–π–¥–µ–Ω–æ</span>
                        </div>
                    </div>
                    ${isComplete ? '<i class="fas fa-check-circle text-green-500"></i>' : ''}
                </button>
            `}).join('');
        }

        function renderTaskCard(topic, task, taskIndex, trainerDisabled) {
            const taskState = getTaskState(topic.id, task.id);
            const theme = getTopicTheme(topic.id);
            const isSolved = taskState.solved;
            const isWrongLocked = taskState.challengeWrong === true;
            const hasAttempts = taskState.attempts > 0;
            const isLastCorrect = taskState.lastWasCorrect === true;
            const cooldownLeftMs = isSolved ? 0 : getTaskCooldownLeftMs(topic.id, task.id);
            const isCooldownActive = cooldownLeftMs > 0;
            const isDisabled = trainerDisabled || isSolved || isWrongLocked || isCooldownActive;
            const taskKey = getTaskKey(topic.id, task.id);
            const cardStateClass = isSolved
                ? 'bg-green-50 border-green-200'
                : (hasAttempts && !isLastCorrect ? 'bg-red-50 border-red-200' : 'bg-gray-50 border-gray-100');

            let taskBody = '';

            if (task.type === "mc") {
                taskBody = `
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        ${task.options.map((opt, optIdx) => {
                            let btnClass = "bg-white border hover:border-purple-300 hover:bg-purple-50 text-gray-600 shadow-sm";
                            let icon = "";
                            if (isSolved) {
                                if (optIdx === task.correct) {
                                    btnClass = "bg-green-500 text-white border-green-600 shadow-md ring-2 ring-green-200";
                                    icon = '<i class="fas fa-check ml-2"></i>';
                                } else {
                                    btnClass = "bg-gray-100 text-gray-400 opacity-50 border-transparent";
                                }
                            } else if (hasAttempts && taskState.lastAnswer === optIdx) {
                                btnClass = "bg-red-400 text-white border-red-500 opacity-90";
                                icon = '<i class="fas fa-times ml-2"></i>';
                            }
                            return `<button
                                ${isDisabled ? 'disabled' : ''}
                                onclick="handleTaskAnswer(${taskIndex}, ${optIdx})"
                                class="px-5 py-3 rounded-xl font-medium text-left transition-all transform active:scale-95 disabled:opacity-60 ${btnClass} flex justify-between items-center">
                                ${opt} ${icon}
                            </button>`;
                        }).join('')}
                    </div>
                `;
            }

            if (task.type === "fill") {
                const inputId = `fill-${topic.id}-${task.id}`;
                const currentValue = typeof taskState.lastAnswer === "string" ? taskState.lastAnswer : "";
                taskBody = `
                    <div class="flex flex-col sm:flex-row gap-3">
                        <input
                            id="${inputId}"
                            type="text"
                            ${isDisabled ? 'disabled' : ''}
                            value="${currentValue.replace(/"/g, '&quot;')}"
                            placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç..."
                            class="flex-1 px-4 py-3 rounded-xl border ${hasAttempts && !isLastCorrect && !isSolved ? 'border-red-300 focus:ring-red-200' : 'border-gray-200 focus:ring-purple-200'} focus:outline-none focus:ring-2 ${isSolved ? 'bg-green-100 text-green-800' : 'bg-white'}"
                        />
                        <button
                            ${isDisabled ? 'disabled' : ''}
                            onclick="submitFillTask(${taskIndex})"
                            class="focus-ring px-5 py-3 rounded-xl font-medium transition-all disabled:opacity-60"
                            style="background:${theme.primary}; color:#fff;">
                            –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
                        </button>
                    </div>
                `;
            }

            if (task.type === "tf") {
                const selectedWrong = !isSolved && hasAttempts && !isLastCorrect ? taskState.lastAnswer : null;
                const trueBtnClass = selectedWrong === true
                    ? "bg-red-400 text-white border-red-500 opacity-90"
                    : (isSolved && task.correct ? "bg-green-500 text-white border-green-600 shadow-md" : "bg-white border hover:border-purple-300 hover:bg-purple-50 text-gray-600 shadow-sm");
                const falseBtnClass = selectedWrong === false
                    ? "bg-red-400 text-white border-red-500 opacity-90"
                    : (isSolved && !task.correct ? "bg-green-500 text-white border-green-600 shadow-md" : "bg-white border hover:border-purple-300 hover:bg-purple-50 text-gray-600 shadow-sm");
                taskBody = `
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <button
                            ${isDisabled ? 'disabled' : ''}
                            onclick="handleTaskAnswer(${taskIndex}, true)"
                            class="px-5 py-3 rounded-xl font-medium text-left transition-all disabled:opacity-60 ${trueBtnClass}">
                            –í–µ—Ä–Ω–æ
                        </button>
                        <button
                            ${isDisabled ? 'disabled' : ''}
                            onclick="handleTaskAnswer(${taskIndex}, false)"
                            class="px-5 py-3 rounded-xl font-medium text-left transition-all disabled:opacity-60 ${falseBtnClass}">
                            –ù–µ–≤–µ—Ä–Ω–æ
                        </button>
                    </div>
                `;
            }

            if (task.type === "match") {
                const draft = getMatchDraft(topic.id, task.id);
                const selectedLeft = draft.selectedLeft;
                const shuffledLeftItems = seededShuffle(task.leftItems, `${topic.id}:${task.id}:L`);
                const shuffledRightItems = seededShuffle(task.rightItems, `${topic.id}:${task.id}:R`);
                const rightItemByKey = Object.fromEntries(task.rightItems.map(item => [item.key, item]));
                const pairEntries = Object.entries(draft.pairs);
                const matchedLeftCount = pairEntries.length;
                const leftTotal = task.leftItems.length;
                const submitDisabled = isDisabled || matchedLeftCount !== leftTotal;
                const usedRightKeys = new Set(Object.values(draft.pairs));

                taskBody = `
                    <div class="mb-3 text-xs text-gray-500">–í—ã–±–µ—Ä–∏ –º–∞—Ä–∫–µ—Ä —Å–ª–µ–≤–∞, –∑–∞—Ç–µ–º –ø–∞—Ä—É —Å–ø—Ä–∞–≤–∞. –°–æ–±—Ä–∞–Ω–æ: ${matchedLeftCount}/${leftTotal}</div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div class="rounded-xl border border-gray-200 bg-white p-3">
                            <p class="text-xs uppercase tracking-wide font-bold text-gray-500 mb-2">${task.leftLabel || 'Left'}</p>
                            <div class="space-y-2">
                                ${shuffledLeftItems.map((item) => {
                                    const isSelected = selectedLeft === item.key;
                                    const isPaired = Boolean(draft.pairs[item.key]);
                                    const btnClass = isSelected
                                        ? "border-sky-400 bg-sky-50 text-sky-800"
                                        : (isPaired ? "border-emerald-300 bg-emerald-50 text-emerald-700" : "border-gray-200 bg-white text-gray-700 hover:border-sky-300");
                                    return `<button
                                        ${isDisabled ? 'disabled' : ''}
                                        onclick="selectMatchLeft(${taskIndex}, '${item.key}')"
                                        class="w-full text-left px-3 py-2 rounded-lg border text-sm font-medium transition-colors disabled:opacity-60 ${btnClass}">
                                        ${item.text}
                                    </button>`;
                                }).join('')}
                            </div>
                        </div>
                        <div class="rounded-xl border border-gray-200 bg-white p-3">
                            <p class="text-xs uppercase tracking-wide font-bold text-gray-500 mb-2">${task.rightLabel || 'Right'}</p>
                            <div class="space-y-2">
                                ${shuffledRightItems.map((item) => {
                                    const isUsed = usedRightKeys.has(item.key);
                                    const btnClass = isUsed
                                        ? "border-emerald-300 bg-emerald-50 text-emerald-700"
                                        : "border-gray-200 bg-white text-gray-700 hover:border-sky-300";
                                    return `<button
                                        ${isDisabled ? 'disabled' : ''}
                                        onclick="selectMatchRight(${taskIndex}, '${item.key}')"
                                        class="w-full text-left px-3 py-2 rounded-lg border text-sm font-medium transition-colors disabled:opacity-60 ${btnClass}">
                                        ${item.text}
                                    </button>`;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                    <div class="mt-3 rounded-xl border border-gray-200 bg-white p-3">
                        <p class="text-xs uppercase tracking-wide font-bold text-gray-500 mb-2">–ü–∞—Ä—ã</p>
                        <div class="space-y-2">
                            ${shuffledLeftItems.map((leftItem) => {
                                const rightKey = draft.pairs[leftItem.key];
                                const rightItem = rightKey ? rightItemByKey[rightKey] : null;
                                return `
                                    <div class="flex items-center justify-between gap-2 text-sm">
                                        <span class="text-gray-700">${leftItem.text}</span>
                                        <div class="flex items-center gap-2">
                                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold ${rightItem ? 'bg-sky-100 text-sky-800 border border-sky-200' : 'bg-gray-100 text-gray-500 border border-gray-200'}">${rightItem ? rightItem.text : '‚Äî'}</span>
                                            ${rightItem && !isDisabled ? `<button onclick="clearMatchPair(${taskIndex}, '${leftItem.key}')" class="text-xs text-red-500 hover:text-red-700 underline">–æ—á–∏—Å—Ç–∏—Ç—å</button>` : ''}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <button
                            ${submitDisabled ? 'disabled' : ''}
                            onclick="submitMatchTask(${taskIndex})"
                            class="focus-ring mt-3 px-5 py-3 rounded-xl font-medium transition-all disabled:opacity-60"
                            style="background:${theme.primary}; color:#fff;">
                            –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–∞—Ä—ã
                        </button>
                    </div>
                `;
            }

            return `
                <div id="task-${topic.id}-${taskIndex}" data-task-index="${taskIndex}" class="mb-6 p-5 border rounded-2xl premium-enter ${cardStateClass} transition-colors duration-300 ${uiState.shakeTaskKey === taskKey ? 'challenge-shake challenge-wrong-glow' : ''} ${uiState.successPulseTaskKey === taskKey ? 'task-success-pulse' : ''}">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-xs font-bold uppercase tracking-wider text-gray-500 bg-white px-2 py-1 rounded">Task ${taskIndex + 1}/${topic.tasks.length}</span>
                        <span class="text-xs text-gray-400">–ü–æ–ø—ã—Ç–∫–∏: ${taskState.attempts}</span>
                    </div>
                    <p class="font-bold text-gray-800 mb-4 text-lg flex gap-2">
                        <span class="bg-white w-8 h-8 flex items-center justify-center rounded-full shadow-sm text-sm border">${taskIndex + 1}</span>
                        ${task.prompt}
                    </p>
                    ${taskBody}
                    ${taskState.challengeWrong ? `
                        <div class="mt-2 text-xs font-bold text-red-600">Wrong answer is locked. Use Try again to reset this topic.</div>
                    ` : ''}
                    ${isCooldownActive ? `
                        <div class="mt-2 text-xs font-bold text-amber-700 bg-amber-50 border border-amber-200 rounded-lg px-3 py-2">
                            –ü–æ–¥–æ–∂–¥–∏ ${Math.max(1, Math.ceil(cooldownLeftMs / 1000))} —Å–µ–∫ –∏ –ø–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞
                        </div>
                    ` : ''}
                    ${hasAttempts ? `
                        <div class="mt-4 p-3 rounded-lg text-sm ${isLastCorrect ? 'text-green-800 bg-green-100/50' : 'text-red-800 bg-red-100/50'} fade-in flex items-start gap-2">
                            <i class="fas ${isLastCorrect ? 'fa-check-circle' : 'fa-info-circle'} mt-1"></i>
                            <div>
                                <span class="font-bold">${isLastCorrect ? '–û—Ç–ª–∏—á–Ω–æ!' : '–ü–æ–∫–∞ –Ω–µ–≤–µ—Ä–Ω–æ.'}</span> ${task.explanation}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderContent() {
            const topic = topics[activeTopicIndex];
            const container = document.getElementById('contentDisplay');
            syncChallengeState(topic.id);
            const challenge = getChallengeState(topic.id);
            const palette = getTopicPalette(topic.id);
            const theme = getTopicTheme(topic.id);
            applyTopicTheme(topic.id);
            const completedCount = getTopicSolvedCount(topic.id);
            const isTrainerUnlocked = !challenge.locked && challenge.isRunning;
            const tasksHTML = topic.tasks.map((task, taskIdx) => renderTaskCard(topic, task, taskIdx, !isTrainerUnlocked)).join('');
            const totalTasks = topic.tasks.length;
            const solvedCount = getTopicSolvedCount(topic.id);
            const progressPercent = totalTasks ? Math.round((solvedCount / totalTasks) * 100) : 0;
            const challengeDurationLabel = formatTime(CHALLENGE_TOTAL_SECONDS);
            const bestTimeHtml = challenge.bestTimeSeconds !== null
                ? `<p class="text-xs text-gray-500 mt-1">Best time: <span class="font-bold text-emerald-600">${formatTime(challenge.bestTimeSeconds)}</span></p>`
                : '';
            let resultSummaryHtml = '';
            if (challenge.lastResult && !challenge.isRunning) {
                if (challenge.lastResult.status === "success") {
                    resultSummaryHtml = `
                        <div class="mt-3 text-sm bg-emerald-50 border border-emerald-200 text-emerald-800 rounded-lg px-3 py-2">
                            Success: ${challenge.lastResult.solved}/${challenge.lastResult.total} in ${formatTime(challenge.lastResult.timeSpentSeconds)}.
                        </div>
                    `;
                } else if (challenge.lastResult.status === "attempted") {
                    resultSummaryHtml = `
                        <div class="mt-3 text-sm bg-amber-50 border border-amber-200 text-amber-800 rounded-lg px-3 py-2">
                            All tasks attempted. Solved ${challenge.lastResult.solved}/${challenge.lastResult.total} in ${formatTime(challenge.lastResult.timeSpentSeconds)}.
                        </div>
                    `;
                } else if (challenge.lastResult.status === "timeout") {
                    resultSummaryHtml = `
                        <div class="mt-3 text-sm bg-red-50 border border-red-200 text-red-700 rounded-lg px-3 py-2">
                            Time is up. Solved ${challenge.lastResult.solved}/${challenge.lastResult.total}.
                        </div>
                    `;
                }
            }

            container.innerHTML = `
                <div class="flex items-center gap-4 mb-8 pb-6 border-b border-gray-100">
                    <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-purple-500 to-indigo-600 flex items-center justify-center text-white text-2xl shadow-lg shadow-purple-200">
                        <i class="fas ${topic.icon}"></i>
                    </div>
                    <div>
                        <h2 class="text-3xl font-extrabold text-gray-800 tracking-tight">${topic.title}</h2>
                        <p class="text-gray-500 font-medium">${topic.summary}</p>
                        <p class="text-xs mt-1 text-gray-400">–ü—Ä–æ–≥—Ä–µ—Å—Å: ${completedCount}/${topic.tasks.length} –∑–∞–¥–∞—á</p>
                    </div>
                </div>

                <div class="prose max-w-none text-gray-600 mb-10">
                    ${topic.theory}
                </div>

                <div class="mb-8 border rounded-xl p-4 premium-enter ${palette.frame}" style="background:${theme.bgSoft}; border-color:${theme.border}">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                        <div>
                            <p class="text-sm font-bold ${palette.frameTitle}" style="color:${theme.text}">Challenge Mode</p>
                            <p class="text-xs ${palette.frameSubtle}" style="color:${theme.text}">Goal: attempt all tasks (${totalTasks}) in ${challengeDurationLabel}.</p>
                            ${bestTimeHtml}
                        </div>
                        <div class="flex items-center gap-3">
                            <button onclick="toggleChallengeSound()" class="focus-ring text-xs px-3 py-2 rounded-lg border bg-white ${palette.controlBtn}" style="border-color:${theme.border}; color:${theme.text}">
                                Sound: ${progressState.challenge.soundEnabled ? 'On' : 'Off'}
                            </button>
                            <button onclick="resetChallengeTopic()" class="focus-ring text-xs px-3 py-2 rounded-lg border bg-white text-gray-600 hover:bg-gray-100" style="border-color:${theme.border}; color:${theme.text}">
                                Reset challenge
                            </button>
                        </div>
                    </div>
                    <div class="mt-4 grid grid-cols-1 sm:grid-cols-3 gap-3 text-sm">
                        <div class="bg-white rounded-lg border border-gray-100 px-3 py-2">
                            <p class="text-gray-500 text-xs">Time left</p>
                            <p class="font-bold text-gray-800">Time left: <span id="challengeTimeLeft">${formatTime(challenge.isRunning ? getRemainingSeconds(topic.id) : (challenge.lastResult ? (Number.isFinite(challenge.lastResult.timeLeftSeconds) ? challenge.lastResult.timeLeftSeconds : Math.max(0, CHALLENGE_TOTAL_SECONDS - Number(challenge.lastResult.timeSpentSeconds || 0))) : CHALLENGE_TOTAL_SECONDS))}</span></p>
                        </div>
                        <div class="bg-white rounded-lg border border-gray-100 px-3 py-2">
                            <p class="text-gray-500 text-xs">Solved</p>
                            <p class="font-bold text-gray-800">Solved <span id="challengeSolvedCount">${solvedCount}/${totalTasks}</span></p>
                        </div>
                        <div class="bg-white rounded-lg border border-gray-100 px-3 py-2">
                            <p class="text-gray-500 text-xs">Status</p>
                            <p id="challengeStatusText" class="font-bold text-gray-800">${challenge.isRunning ? 'Challenge is running' : (challenge.lastResult ? (challenge.lastResult.status === "success" ? `Success in ${formatTime(challenge.lastResult.timeSpentSeconds)}` : (challenge.lastResult.status === "attempted" ? `All tasks attempted in ${formatTime(challenge.lastResult.timeSpentSeconds)}` : 'Time is up')) : 'Locked')}</p>
                        </div>
                    </div>
                    <div class="mt-3 h-2 bg-white rounded-full overflow-hidden border border-gray-100">
                        <div id="challengeProgressBar" class="h-full ${palette.progressBar} transition-all" style="width:${progressPercent}%"></div>
                    </div>
                    ${resultSummaryHtml}
                    <div class="mt-4 flex flex-wrap items-center gap-3">
                        <button onclick="startTopicChallenge()" class="focus-ring px-4 py-2 rounded-lg font-semibold text-sm transition-colors ${palette.startBtn}" style="background:${theme.primary}; border-color:${theme.primary}; color:#fff;">
                            I‚Äôve read the rule ‚Äî Start ${challengeDurationLabel} challenge
                        </button>
                        ${challenge.lastResult && !challenge.isRunning ? `
                            <button onclick="resetChallengeTopic()" class="focus-ring px-4 py-2 rounded-lg bg-white border text-gray-700 hover:bg-gray-100 font-semibold text-sm" style="border-color:${theme.border}; color:${theme.text}">
                                Try again
                            </button>
                        ` : ''}
                    </div>
                </div>

                <div class="bg-white">
                    <h3 class="text-xl font-bold mb-6 flex items-center gap-2 text-gray-700">
                        <span class="bg-indigo-100 text-indigo-600 w-8 h-8 rounded-lg flex items-center justify-center text-sm"><i class="fas fa-dumbbell"></i></span>
                        –¢—Ä–µ–Ω–∞–∂–µ—Ä
                    </h3>
                    <div class="relative">
                        ${tasksHTML}
                        ${!isTrainerUnlocked ? `
                            <div class="trainer-overlay ${palette.frameSubtle}">
                                <div class="border rounded-xl px-4 py-3 shadow-sm ${palette.lockCard}" style="background:${theme.bgSoft}; border-color:${theme.border}; color:${theme.text}">
                                    <p class="text-sm font-bold ${palette.frameTitle}" style="color:${theme.text}">Trainer is locked</p>
                                    <p class="text-xs mt-1">Read the rule and start the ${challengeDurationLabel} challenge to unlock tasks.</p>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
                ${challenge.isRunning ? `
                    <div id="floatingChallengeTimer" class="floating-timer-hud rounded-xl border px-4 py-3 ${palette.floating}" style="background:${theme.bgSoft}; border-color:${theme.border}; color:${theme.text}">
                        <div class="flex items-center justify-between gap-4">
                            <div>
                                <p class="text-[11px] uppercase tracking-wider font-extrabold opacity-80">Challenge Timer</p>
                                <p class="text-lg font-black leading-tight" id="floatingChallengeTimeLeft">${formatTime(getRemainingSeconds(topic.id))}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-[11px] uppercase tracking-wider font-extrabold opacity-80">Solved</p>
                                <p class="text-base font-extrabold"><span id="floatingChallengeSolvedCount">${solvedCount}/${totalTasks}</span></p>
                            </div>
                        </div>
                        <p id="floatingChallengeStatusText" class="text-xs font-semibold mt-2 opacity-90">Challenge is running</p>
                        <div class="mt-2">
                            <button onclick="toggleChallengeSound()" class="text-xs px-2 py-1 rounded-md border bg-white/70 ${palette.controlBtn}">
                                ${progressState.challenge.soundEnabled ? 'üîä –ó–≤—É–∫' : 'üîá –ë–µ–∑ –∑–≤—É–∫–∞'}
                            </button>
                        </div>
                    </div>
                ` : ''}
            `;

            container.classList.remove('fade-in');
            void container.offsetWidth;
            container.classList.add('fade-in');
            if (challenge.isRunning) {
                startChallengeTimer(topic.id);
            } else {
                stopChallengeTimer();
            }
            renderChallengeHud();
        }

        function renderTimeline() {
            const container = document.getElementById('planTimeline');
            container.innerHTML = studyPlan.map((day, idx) => {
                const isDone = progressState.dayState[idx] === true;
                return `
                <div onclick="toggleDay(${idx})" 
                    class="day-card min-w-[220px] md:min-w-[240px] bg-white border border-gray-100 rounded-2xl p-5 shadow-sm hover:shadow-lg relative overflow-hidden group ${isDone ? 'completed' : ''}">

                    <div class="absolute top-0 right-0 w-16 h-16 bg-gradient-to-bl from-gray-100 to-transparent rounded-bl-full -mr-8 -mt-8 transition-colors group-hover:from-purple-100"></div>

                    <div class="flex justify-between items-center mb-3 relative z-10">
                        <span class="font-bold ${isDone ? 'text-green-600' : 'text-gray-400'} text-xs uppercase tracking-wider bg-gray-50 px-2 py-1 rounded">–î–µ–Ω—å ${day.day}</span>
                        <div class="check-icon w-6 h-6 rounded-full border-2 border-gray-200 flex items-center justify-center transition-all">
                            <i class="fas fa-check text-xs ${isDone ? '' : 'opacity-0'}"></i>
                        </div>
                    </div>

                    <h4 class="font-bold text-gray-800 mb-2 leading-tight relative z-10">${day.title}</h4>
                    <p class="text-xs text-gray-500 leading-relaxed relative z-10">${day.task}</p>

                    ${isDone ? '<div class="absolute inset-0 flex items-center justify-center opacity-10 pointer-events-none"><i class="fas fa-check-circle text-6xl text-green-500"></i></div>' : ''}
                </div>
            `}).join('');
        }

        /* --- 5. INTERACTION LOGIC --- */
        function isTaskAnswerCorrect(task, userAnswer) {
            if (task.type === "mc") return Number(userAnswer) === task.correct;
            if (task.type === "tf") return Boolean(userAnswer) === Boolean(task.correct);
            if (task.type === "fill") {
                const normalizedAnswer = normalizeAnswer(userAnswer);
                const accepted = (task.acceptedAnswers || [task.correct]).map(normalizeAnswer);
                return accepted.includes(normalizedAnswer);
            }
            if (task.type === "match") {
                if (!userAnswer || typeof userAnswer !== "object" || !userAnswer.pairs) return false;
                const expectedPairs = task.correct || {};
                const actualPairs = userAnswer.pairs || {};
                const expectedKeys = Object.keys(expectedPairs);
                if (Object.keys(actualPairs).length !== expectedKeys.length) return false;
                return expectedKeys.every((leftKey) => actualPairs[leftKey] === expectedPairs[leftKey]);
            }
            return false;
        }

        window.setActiveTopic = (index) => {
            activeTopicIndex = index;
            renderTabs();
            renderContent();
            renderDashboardCards();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.handleTaskAnswer = (taskIndex, userAnswer) => {
            const topic = topics[activeTopicIndex];
            syncChallengeState(topic.id);
            const challenge = getChallengeState(topic.id);
            if (challenge.locked || !challenge.isRunning) return;
            const task = topic.tasks[taskIndex];
            const taskState = getTaskState(topic.id, task.id);
            if (taskState.challengeWrong) return;
            if (getTaskCooldownLeftMs(topic.id, task.id) > 0) return;
            const isCorrect = isTaskAnswerCorrect(task, userAnswer);
            const taskKey = getTaskKey(topic.id, task.id);

            taskState.attempts += 1;
            taskState.lastAnswer = userAnswer;
            taskState.lastWasCorrect = isCorrect;
            taskState.lastUpdated = new Date().toISOString();
            taskState.challengeWrong = !isCorrect;
            recordDailyPracticeAttempt({ isCorrect });
            if (isCorrect) {
                taskState.correct = true;
                taskState.solved = true;
                delete uiState.cooldownUntilByTaskKey[taskKey];
            }
            if (task.type === "match") {
                clearMatchDraft(topic.id, task.id);
            }

            saveProgress();
            renderTabs();

            if (isCorrect) {
                playSuccessSound();
                uiState.successPulseTaskKey = taskKey;
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 },
                    colors: ['#a855f7', '#3b82f6', '#22c55e']
                });
                if (getTopicSolvedCount(topic.id) === topic.tasks.length) {
                    completeChallenge(topic.id, "success");
                    stopChallengeTimer();
                }
                renderContent();
                setTimeout(() => {
                    if (topics[activeTopicIndex] && topics[activeTopicIndex].id === topic.id) {
                        scrollToNextTask(topic.id, taskIndex);
                    }
                }, 90);
                setTimeout(() => {
                    if (uiState.successPulseTaskKey === taskKey) {
                        uiState.successPulseTaskKey = null;
                        if (topics[activeTopicIndex] && topics[activeTopicIndex].id === topic.id) {
                            renderContent();
                        }
                    }
                }, 680);
            } else {
                playErrorSound();
                uiState.shakeTaskKey = taskKey;
                renderContent();
                setTimeout(() => {
                    if (uiState.shakeTaskKey === taskKey) {
                        uiState.shakeTaskKey = null;
                        if (topics[activeTopicIndex] && topics[activeTopicIndex].id === topic.id) {
                            renderContent();
                        }
                    }
                }, 400);
            }

            syncChallengeState(topic.id);
        };

        window.submitFillTask = (taskIndex) => {
            const topic = topics[activeTopicIndex];
            syncChallengeState(topic.id);
            const challenge = getChallengeState(topic.id);
            if (challenge.locked || !challenge.isRunning) return;
            const task = topic.tasks[taskIndex];
            const input = document.getElementById(`fill-${topic.id}-${task.id}`);
            if (!input) return;
            const value = input.value;
            if (!String(value).trim()) return;
            window.handleTaskAnswer(taskIndex, value);
        };

        window.selectMatchLeft = (taskIndex, leftKey) => {
            const topic = topics[activeTopicIndex];
            const challenge = getChallengeState(topic.id);
            if (challenge.locked || !challenge.isRunning) return;
            const task = topic.tasks[taskIndex];
            const taskState = getTaskState(topic.id, task.id);
            if (task.type !== "match" || taskState.solved || taskState.challengeWrong) return;
            const draft = getMatchDraft(topic.id, task.id);
            draft.selectedLeft = leftKey;
            renderContent();
        };

        window.selectMatchRight = (taskIndex, rightKey) => {
            const topic = topics[activeTopicIndex];
            const challenge = getChallengeState(topic.id);
            if (challenge.locked || !challenge.isRunning) return;
            const task = topic.tasks[taskIndex];
            const taskState = getTaskState(topic.id, task.id);
            if (task.type !== "match" || taskState.solved || taskState.challengeWrong) return;
            const draft = getMatchDraft(topic.id, task.id);
            if (!draft.selectedLeft) return;
            draft.pairs[draft.selectedLeft] = rightKey;
            draft.selectedLeft = null;
            renderContent();
        };

        window.clearMatchPair = (taskIndex, leftKey) => {
            const topic = topics[activeTopicIndex];
            const challenge = getChallengeState(topic.id);
            if (challenge.locked || !challenge.isRunning) return;
            const task = topic.tasks[taskIndex];
            const taskState = getTaskState(topic.id, task.id);
            if (task.type !== "match" || taskState.solved || taskState.challengeWrong) return;
            const draft = getMatchDraft(topic.id, task.id);
            delete draft.pairs[leftKey];
            if (draft.selectedLeft === leftKey) {
                draft.selectedLeft = null;
            }
            renderContent();
        };

        window.submitMatchTask = (taskIndex) => {
            const topic = topics[activeTopicIndex];
            syncChallengeState(topic.id);
            const challenge = getChallengeState(topic.id);
            if (challenge.locked || !challenge.isRunning) return;
            const task = topic.tasks[taskIndex];
            const taskState = getTaskState(topic.id, task.id);
            if (task.type !== "match" || taskState.solved || taskState.challengeWrong) return;
            const draft = getMatchDraft(topic.id, task.id);
            if (Object.keys(draft.pairs).length !== task.leftItems.length) return;
            const answerPayload = {
                pairs: { ...draft.pairs }
            };
            window.handleTaskAnswer(taskIndex, answerPayload);
        };

        window.startTopicChallenge = () => {
            const topic = topics[activeTopicIndex];
            const challenge = getChallengeState(topic.id);
            initAudioIfNeeded();
            challenge.locked = false;
            challenge.isRunning = true;
            challenge.isCompleted = false;
            challenge.startedAt = new Date().toISOString();
            challenge.endAt = new Date(Date.now() + CHALLENGE_TOTAL_SECONDS * 1000).toISOString();
            challenge.lastResult = null;
            saveProgress();
            renderContent();
            showToast(`Challenge started: ${topic.title}`, "info");
            if (getTopicSolvedCount(topic.id) === topic.tasks.length) {
                completeChallenge(topic.id, "success");
            } else if (areAllTopicTasksAttempted(topic.id)) {
                completeChallenge(topic.id, "attempted");
            }
        };

        window.resetChallengeTopic = () => {
            const topic = topics[activeTopicIndex];
            const challenge = getChallengeState(topic.id);
            console.log(`[reset] Topic reset started: ${topic.id}`);
            challenge.locked = true;
            challenge.isRunning = false;
            challenge.isCompleted = false;
            challenge.startedAt = null;
            challenge.endAt = null;
            challenge.lastResult = null;
            topic.tasks.forEach(task => {
                progressState.topicTaskState[topic.id][task.id] = createDefaultTaskState();
                clearMatchDraft(topic.id, task.id);
            });
            stopChallengeTimer();
            saveProgress();
            renderContent();
            console.log(`[reset] Topic reset completed: ${topic.id}`);
            showToast(`Reset done: ${topic.title}`, "info");
        };

        window.toggleChallengeSound = () => {
            progressState.challenge.soundEnabled = !progressState.challenge.soundEnabled;
            saveProgress();
            renderContent();
        };

        window.toggleDay = (index) => {
            progressState.dayState[index] = !progressState.dayState[index];
            saveProgress();
            renderTimeline();

            if (progressState.dayState[index]) {
                confetti({
                    particleCount: 50,
                    spread: 50,
                    origin: { y: 0.8 },
                    colors: ['#facc15', '#22c55e']
                });
            }
        };

        window.onload = () => {
            loadProgress();
            renderTabs();
            renderContent();
            renderTimeline();
            setupTopicStatsObserver();
            setupStickyBarScrollFx();
        };
    </script>
</body>
</html>
